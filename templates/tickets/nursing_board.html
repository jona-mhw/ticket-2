{% extends "base.html" %}

{% block title %}Tablero de Enfermería - Ticket Home{% endblock %}

{% block content %}
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<!-- STICKY HEADER -->
<div class="sticky-header bg-white shadow-md border-b border-gray-200 -mt-6 -mx-6 px-6 py-4 mb-4">
    <!-- Title Row -->
    <div class="flex items-center justify-between mb-3">
        <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                </path>
            </svg>
            Tablero de Enfermería
            <span class="text-sm font-normal text-gray-500">({{ stats.total }} pacientes)</span>
        </h1>

        <!-- View Switcher -->
        <div class="flex border border-gray-300 rounded-lg overflow-hidden shadow-sm">
            <a href="{{ url_for('tickets.nursing_board') }}"
                class="px-4 py-2 bg-blue-600 text-white text-sm font-medium flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                    </path>
                </svg>
                Tablero
            </a>
            <a href="{{ url_for('tickets.nursing_list') }}"
                class="px-4 py-2 bg-white text-gray-700 hover:bg-gray-50 text-sm font-medium border-l border-gray-300 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                    </path>
                </svg>
                Lista
            </a>
        </div>
    </div>

    <!-- Clinic Filter for Superuser - Issue #88: Filtro de clínica para superusuario -->
    {% if current_user.is_superuser %}
    <div class="flex items-center gap-2 mt-3 mb-6 pb-4 border-b border-gray-200">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider" title="Issue #88: Permite al superusuario ver tickets de todas las clínicas o filtrar por una específica">Clínica:</span>
        <form method="GET" action="{{ url_for('tickets.nursing_board') }}" class="flex gap-2">
            <!-- Pass existing filters -->
            <input type="hidden" name="status" value="{{ filters.status if filters.status else '' }}">
            <input type="hidden" name="search" value="{{ filters.search if filters.search else '' }}">
            <input type="hidden" name="date_from" value="{{ filters.date_from if filters.date_from else '' }}">
            <input type="hidden" name="date_to" value="{{ filters.date_to if filters.date_to else '' }}">

            <select name="clinic_id" class="px-2 py-1 border border-gray-300 rounded text-sm"
                onchange="this.form.submit()">
                <option value="">Ver todas</option>
                {% for clinic in clinics %}
                <option value="{{ clinic.id }}" {% if filters.clinic_id|int == clinic.id %}selected{% endif %}>
                    {{ clinic.name }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>
    {% endif %}

    <!-- Filters Row -->
    <div class="flex items-center gap-3 flex-wrap">
        <!-- Ticket Status Filter - Simplificado: Vigentes incluye programados al final -->
        <div class="flex items-center gap-2">
            <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Estado:</span>
            <div class="flex gap-2">
                <a href="{{ url_for('tickets.nursing_board', search=filters.search if filters.search else '') }}"
                    class="filter-pill {% if not filters.status %}filter-pill-active{% else %}filter-pill-inactive{% endif %}">
                    <span>Todos</span>
                    <span class="filter-count">{{ stats.total }}</span>
                </a>
                <a href="{{ url_for('tickets.nursing_board', status='Vigente', search=filters.search if filters.search else '') }}"
                    class="filter-pill filter-pill-normal {% if filters.status == 'Vigente' %}filter-pill-active{% else %}filter-pill-inactive{% endif %}">
                    <span>Vigentes</span>
                    <span class="filter-count">{{ stats.normal + stats.scheduled }}</span>
                </a>
                <a href="{{ url_for('tickets.nursing_board', status='Vencido', search=filters.search if filters.search else '') }}"
                    class="filter-pill filter-pill-expired {% if filters.status == 'Vencido' %}filter-pill-active{% else %}filter-pill-inactive{% endif %}">
                    <span>Vencidos</span>
                    <span class="filter-count">{{ stats.expired }}</span>
                </a>
                <a href="{{ url_for('tickets.nursing_board', status='Anulado', search=filters.search if filters.search else '') }}"
                    class="filter-pill {% if filters.status == 'Anulado' %}filter-pill-active{% else %}filter-pill-inactive{% endif %}">
                    <span>Anulados</span>
                    <span class="filter-count">{{ stats.annulled|default(0) }}</span>
                </a>
            </div>
        </div>

        <!-- Sort Controls - Issue #90: Controles de ordenamiento por fecha -->
        <div class="flex items-center gap-2">
            <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider" title="Ordenar por Fecha Alta (FPA) o Fecha de Creación del ticket.">Ordenar:</span>
            <form method="GET" class="flex items-center gap-2">
                {% if filters.status %}<input type="hidden" name="status" value="{{ filters.status }}">{% endif %}
                {% if filters.search %}<input type="hidden" name="search" value="{{ filters.search }}">{% endif %}
                {% if filters.clinic_id %}<input type="hidden" name="clinic_id" value="{{ filters.clinic_id }}">{% endif %}
                {% if filters.date_from %}<input type="hidden" name="date_from" value="{{ filters.date_from }}">{% endif %}
                {% if filters.date_to %}<input type="hidden" name="date_to" value="{{ filters.date_to }}">{% endif %}

                <select name="sort_by" class="px-2 py-1 border border-gray-300 rounded text-sm" onchange="this.form.submit()">
                    <option value="discharge_date" {% if sort_by == 'discharge_date' %}selected{% endif %}>Fecha Alta</option>
                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Fecha Creación</option>
                </select>

                <select name="sort_dir" class="px-2 py-1 border border-gray-300 rounded text-sm" onchange="this.form.submit()">
                    <option value="desc" {% if sort_dir == 'desc' %}selected{% endif %}>⬇️ Reciente</option>
                    <option value="asc" {% if sort_dir == 'asc' %}selected{% endif %}>⬆️ Antiguo</option>
                </select>
            </form>
        </div>

        <!-- Date Range Filter -->
        <div class="flex items-center gap-2">
            <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Rango fechas:</span>
            <form method="GET" class="flex items-center gap-2">
                {% if filters.status %}<input type="hidden" name="status" value="{{ filters.status }}">{% endif %}
                {% if filters.search %}<input type="hidden" name="search" value="{{ filters.search }}">{% endif %}
                {% if filters.clinic_id %}<input type="hidden" name="clinic_id" value="{{ filters.clinic_id }}">{% endif %}
                {% if sort_by %}<input type="hidden" name="sort_by" value="{{ sort_by }}">{% endif %}
                {% if sort_dir %}<input type="hidden" name="sort_dir" value="{{ sort_dir }}">{% endif %}

                <input type="date" name="date_from" value="{{ filters.date_from }}"
                    class="px-2 py-1 border border-gray-300 rounded text-sm" title="Fecha desde (creación)">
                <span class="text-gray-400">-</span>
                <input type="date" name="date_to" value="{{ filters.date_to }}"
                    class="px-2 py-1 border border-gray-300 rounded text-sm" title="Fecha hasta (creación)">
                <button type="submit" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded">
                    Filtrar
                </button>
            </form>
        </div>

        <!-- Search Filter -->
        <div class="flex items-center gap-2 ml-auto">
            <form method="GET" class="flex items-center gap-2">
                {% if filters.status %}
                <input type="hidden" name="status" value="{{ filters.status }}">
                {% endif %}
                {% if sort_by %}
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                {% endif %}
                {% if sort_dir %}
                <input type="hidden" name="sort_dir" value="{{ sort_dir }}">
                {% endif %}
                {% if filters.clinic_id %}
                <input type="hidden" name="clinic_id" value="{{ filters.clinic_id }}">
                {% endif %}
                <div class="relative">
                    <input type="search" name="search" value="{{ filters.search }}"
                        placeholder="Buscar paciente, RUT, cama, ubicación..."
                        class="pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-72">
                    <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                    Buscar
                </button>
                {% if filters.search or filters.status %}
                <a href="{{ url_for('tickets.nursing_board') }}"
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors">
                    Limpiar filtros
                </a>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<!-- PATIENT CARDS GRID -->
{% if tickets %}
<div class="nursing-board-grid">
    {% for ticket in tickets %}
    <div class="patient-card urgency-{{ ticket.urgency_level }}"
        data-fpa="{{ ticket.current_fpa.isoformat() if ticket.current_fpa else '' }}">
        <!-- Urgency Indicator Bar -->
        <div class="urgency-bar urgency-{{ ticket.urgency_level }}"></div>

        <!-- Card Header: Bed/Location -->
        <div class="card-header" style="padding-bottom: 0; border-bottom: 1px solid #e5e7eb;">
            <div class="bed-location-header"
                style="border-bottom: none; background: transparent; padding: 0; width: 100%;">
                <!-- Bed Number Field -->
                <div class="bed-field {% if ticket.status != 'Anulado' and ticket.urgency_level != 'expired' %}editable-field{% endif %}"
                    data-ticket-id="{{ ticket.id }}" data-field="bed_number"
                    data-current-value="{{ ticket.bed_number or '' }}"
                    data-ticket-status="{{ ticket.status }}"
                    data-ticket-urgency="{{ ticket.urgency_level }}"
                    title="{% if ticket.status == 'Anulado' %}Ticket anulado - no editable{% elif ticket.urgency_level == 'expired' %}Ticket vencido - no editable{% else %}Clic para editar cama{% endif %}">
                    <svg class="w-4 h-4 field-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span class="field-label">Cama:</span>
                    <span class="field-display">{{ ticket.bed_number or '-' }}</span>
                    <input type="text" class="field-input" value="{{ ticket.bed_number or '' }}" placeholder="201"
                        maxlength="10" style="display: none;">
                </div>

                <!-- Location Field -->
                <div class="location-field {% if ticket.status != 'Anulado' and ticket.urgency_level != 'expired' %}editable-field{% endif %}"
                    data-ticket-id="{{ ticket.id }}" data-field="location"
                    data-current-value="{{ ticket.location or '' }}"
                    data-ticket-status="{{ ticket.status }}"
                    data-ticket-urgency="{{ ticket.urgency_level }}"
                    title="{% if ticket.status == 'Anulado' %}Ticket anulado - no editable{% elif ticket.urgency_level == 'expired' %}Ticket vencido - no editable{% else %}Clic para editar ubicación{% endif %}">
                    <svg class="w-4 h-4 field-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="field-label">Ubic:</span>
                    <span class="field-display">{{ ticket.location or '-' }}</span>
                    <input type="text" class="field-input" value="{{ ticket.location or '' }}" placeholder="Piso 2"
                        maxlength="50" style="display: none;">
                </div>
            </div>
        </div>

        <!-- Patient Info Below Header -->
        <div class="px-4 pt-3 pb-3">
            <div class="patient-name font-bold text-gray-800 truncate" title="{{ ticket.patient.full_name }}">
                {{ ticket.patient.full_name }}
            </div>
            <div class="patient-rut text-sm text-gray-600 mt-1">
                RUT: {{ ticket.patient.rut }}
            </div>
            <div class="mt-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    {% if ticket.status == 'Vigente' %}bg-green-100 text-green-800
                    {% elif ticket.status == 'Anulado' %}bg-red-100 text-red-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ ticket.status }}
                </span>
            </div>
        </div>

        <!-- FPA Countdown - LARGE AND PROMINENT -->
        <div class="fpa-section">
            <div class="fpa-label">Fecha Probable de Alta</div>
            <div class="fpa-date">{{ ticket.current_fpa.strftime('%d/%m/%Y') }}</div>
            <div class="fpa-time">{{ ticket.calculated_discharge_time_block }}</div>

            {% if ticket.status == 'Anulado' %}
            {# No mostrar timer para tickets anulados #}
            <div class="countdown-display" style="background-color: #fee2e2; color: #991b1b;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
                <span>TICKET ANULADO</span>
            </div>
            {% elif ticket.is_scheduled %}
            <div class="countdown-display countdown-scheduled">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                <span>PROGRAMADO</span>
            </div>
            <div class="scheduled-countdown text-center text-xs text-blue-700 font-semibold mt-1"
                data-scheduled-fpa="{{ ticket.current_fpa.isoformat() if ticket.current_fpa else '' }}">
                <!-- JS will populate this -->
            </div>
            {% elif ticket.time_remaining %}
            <div class="countdown-display countdown-{{ ticket.urgency_level }}" data-countdown-target>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="countdown-time">Calculando...</span>
            </div>
            {% endif %}
        </div>

        <!-- Medical Info -->
        <div class="medical-info">
            <div class="info-row">
                <div class="info-icon">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                        </path>
                    </svg>
                </div>
                <div class="info-content">
                    <div class="info-label">Cirugía</div>
                    <div class="info-value">{{ ticket.surgery.name }}</div>
                    <div class="info-secondary">{{ ticket.surgery.specialty.name }}</div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-icon">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div class="info-content">
                    <div class="info-label">Médico Tratante</div>
                    <div class="info-value">{{ ticket.attending_doctor.name if ticket.attending_doctor else 'Sin
                        asignar' }}</div>
                    {% if ticket.attending_doctor %}
                    <div class="info-secondary">{{ ticket.attending_doctor.specialty }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="info-row">
                <div class="info-icon">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                        </path>
                    </svg>
                </div>
                <div class="info-content">
                    <div class="info-label">ID Ticket</div>
                    <div class="info-value font-mono text-sm">{{ ticket.id }}</div>
                </div>
            </div>
        </div>

        <!-- Card Footer: Actions -->
        <div class="card-footer">
            <a href="{{ url_for('tickets.detail', ticket_id=ticket.id) }}" class="btn-card btn-card-primary">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                    </path>
                </svg>
                Ver Detalle
            </a>
            {% if ticket.get_modification_count() > 0 %}
            <span class="modification-badge">
                {{ ticket.get_modification_count() }} modificación(es)
            </span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
        </path>
    </svg>
    <h3 class="empty-title">No hay tickets vigentes</h3>
    <p class="empty-description">
        {% if filters.search or filters.urgency %}
        No se encontraron tickets que coincidan con los filtros aplicados.
        {% else %}
        Todos los pacientes han sido dados de alta.
        {% endif %}
    </p>
    <div class="empty-actions">
        {% if filters.search or filters.urgency %}
        <a href="{{ url_for('tickets.nursing_board') }}" class="btn-primary">Ver todos los tickets</a>
        {% endif %}
        <a href="{{ url_for('tickets.create') }}" class="btn-secondary">Crear nuevo ticket</a>
    </div>
</div>
{% endif %}

<style>
    /* ===== STICKY HEADER ===== */
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 40;
        backdrop-filter: blur(8px);
        background-color: rgba(255, 255, 255, 0.98);
    }

    /* ===== FILTER PILLS ===== */
    .filter-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid transparent;
        text-decoration: none;
    }

    .filter-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .filter-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        height: 1.5rem;
        padding: 0 0.375rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    /* Filter States - Inactive */
    .filter-pill-inactive {
        background: #f3f4f6;
        color: #6b7280;
        border-color: #e5e7eb;
    }

    .filter-pill-inactive .filter-count {
        background: #e5e7eb;
        color: #4b5563;
    }

    .filter-pill-inactive:hover {
        background: #e5e7eb;
        border-color: #d1d5db;
    }

    /* Filter States - Active (Generic) */
    .filter-pill-active {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
    }

    /* Todos Filter */
    .filter-pill-active:not([class*="filter-pill-critical"]):not([class*="filter-pill-warning"]):not([class*="filter-pill-normal"]):not([class*="filter-pill-expired"]):not([class*="filter-pill-scheduled"]) {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border-color: #1d4ed8;
    }

    .filter-pill-active:not([class*="filter-pill-critical"]):not([class*="filter-pill-warning"]):not([class*="filter-pill-normal"]):not([class*="filter-pill-expired"]):not([class*="filter-pill-scheduled"]) .filter-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    /* Critical Filter */
    .filter-pill-critical.filter-pill-inactive {
        background: #fef2f2;
        color: #991b1b;
        border-color: #fecaca;
    }

    .filter-pill-critical.filter-pill-active {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        border-color: #991b1b;
        animation: pulse-critical 2s infinite;
    }

    .filter-pill-critical.filter-pill-active .filter-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    @keyframes pulse-critical {

        0%,
        100% {
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        50% {
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.6);
        }
    }

    /* Warning Filter */
    .filter-pill-warning.filter-pill-inactive {
        background: #fff7ed;
        color: #9a3412;
        border-color: #fed7aa;
    }

    .filter-pill-warning.filter-pill-active {
        background: linear-gradient(135deg, #ea580c, #c2410c);
        color: white;
        border-color: #9a3412;
    }

    .filter-pill-warning.filter-pill-active .filter-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    /* Normal Filter */
    .filter-pill-normal.filter-pill-inactive {
        background: #ecfdf5;
        color: #065f46;
        border-color: #a7f3d0;
    }

    .filter-pill-normal.filter-pill-active {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        border-color: #065f46;
    }

    .filter-pill-normal.filter-pill-active .filter-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    /* Expired Filter */
    .filter-pill-expired.filter-pill-inactive {
        background: #f9fafb;
        color: #4b5563;
        border-color: #e5e7eb;
    }

    .filter-pill-expired.filter-pill-active {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        color: white;
        border-color: #374151;
    }

    .filter-pill-expired.filter-pill-active .filter-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    /* Scheduled Filter */
    .filter-pill-scheduled.filter-pill-inactive {
        background: #eff6ff;
        color: #1e40af;
        border-color: #bfdbfe;
    }

    .filter-pill-scheduled.filter-pill-active {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        border-color: #1e40af;
    }

    .filter-pill-scheduled.filter-pill-active .filter-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .stat-count {
        font-size: 1rem;
        font-weight: 700;
    }

    .stat-label {
        font-weight: 500;
    }

    /* ===== GRID LAYOUT ===== */
    .nursing-board-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1rem;
        padding-bottom: 2rem;
    }

    @media (max-width: 640px) {
        .nursing-board-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 1920px) {
        .nursing-board-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
    }

    /* ===== PATIENT CARD ===== */
    .patient-card {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        overflow: hidden;
        position: relative;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
    }

    .patient-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
    }

    /* Urgency Bar - Top Border */
    .urgency-bar {
        height: 6px;
        width: 100%;
    }

    .urgency-bar.urgency-critical {
        background: linear-gradient(90deg, #dc2626, #ef4444);
    }

    .urgency-bar.urgency-warning {
        background: linear-gradient(90deg, #ea580c, #f97316);
    }

    .urgency-bar.urgency-normal {
        background: linear-gradient(90deg, #059669, #10b981);
    }

    .urgency-bar.urgency-expired {
        background: linear-gradient(90deg, #4b5563, #6b7280);
    }

    .urgency-bar.urgency-scheduled {
        background: linear-gradient(90deg, #2563eb, #3b82f6);
    }

    /* Card Header */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 1rem 1rem 0.75rem 1rem;
        gap: 0.75rem;
    }

    .patient-info {
        flex: 1;
        min-width: 0;
    }

    .patient-name {
        font-size: 1rem;
        font-weight: 700;
        color: #111827;
        line-height: 1.3;
        margin-bottom: 0.25rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .patient-rut {
        font-size: 0.8125rem;
        color: #6b7280;
        font-weight: 500;
    }

    /* Bed and Location Header (Issue #49) */
    .bed-location-header {
        display: flex;
        gap: 0.75rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        color: #6b7280;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .bed-field,
    .location-field {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    /* Campos editables */
    .bed-field.editable-field,
    .location-field.editable-field {
        cursor: pointer;
    }

    .bed-field.editable-field:hover,
    .location-field.editable-field:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    /* Campos NO editables (anulados/vencidos) */
    .bed-field:not(.editable-field),
    .location-field:not(.editable-field) {
        cursor: not-allowed;
        opacity: 0.6;
        background: #f9fafb;
    }

    .bed-field:not(.editable-field):hover,
    .location-field:not(.editable-field):hover {
        background: #f9fafb;
        border-color: transparent;
    }

    .field-icon {
        width: 0.875rem;
        height: 0.875rem;
        color: #9ca3af;
    }

    .field-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .field-display {
        font-weight: 600;
        color: #111827;
        font-size: 0.75rem;
        user-select: none;
    }

    .field-input {
        font-size: 0.75rem;
        font-weight: 600;
        color: #111827;
        border: 1px solid #3b82f6;
        border-radius: 0.25rem;
        padding: 0.25rem 0.375rem;
        background: white;
        outline: none;
        min-width: 60px;
    }

    .field-input:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .editable-field.editing {
        background: white;
        border-color: #3b82f6;
    }

    .editable-field.editing .field-icon,
    .editable-field.editing .field-label,
    .editable-field.editing .field-display {
        display: none;
    }

    /* FPA Section - PROMINENT */
    .fpa-section {
        background: linear-gradient(135deg, #eff6ff, #dbeafe);
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
        text-align: center;
    }

    .urgency-critical .fpa-section {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }

    .urgency-warning .fpa-section {
        background: linear-gradient(135deg, #fff7ed, #fed7aa);
    }

    .urgency-normal .fpa-section {
        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    }

    .urgency-expired .fpa-section {
        background: linear-gradient(135deg, #f9fafb, #f3f4f6);
    }

    .fpa-label {
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6b7280;
        margin-bottom: 0.375rem;
    }

    .fpa-date {
        font-size: 1.5rem;
        font-weight: 800;
        color: #111827;
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .fpa-time {
        font-size: 0.8125rem;
        color: #4b5563;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* Countdown Display */
    .countdown-display {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.9375rem;
        font-weight: 700;
        margin-top: 0.375rem;
    }

    .countdown-critical {
        background: #dc2626;
        color: white;
    }

    .countdown-warning {
        background: #ea580c;
        color: white;
    }

    .countdown-normal {
        background: #059669;
        color: white;
    }

    .countdown-expired {
        background: #4b5563;
        color: white;
    }

    .countdown-scheduled {
        background: #2563eb;
        color: white;
    }

    .countdown-time {
        font-family: 'Courier New', monospace;
        font-size: 1rem;
    }

    /* Medical Info */
    .medical-info {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        flex: 1;
    }

    .info-row {
        display: flex;
        gap: 0.625rem;
        align-items: flex-start;
    }

    .info-icon {
        flex-shrink: 0;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
        border-radius: 0.375rem;
        color: #6b7280;
    }

    .info-icon svg {
        width: 0.875rem;
        height: 0.875rem;
    }

    .info-content {
        flex: 1;
    }

    .info-label {
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #9ca3af;
        margin-bottom: 0.125rem;
    }

    .info-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: #111827;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .info-secondary {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.0625rem;
    }

    /* Card Footer */
    .card-footer {
        padding: 0.75rem 1rem;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.625rem;
    }

    .btn-card {
        flex: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 0.5rem;
        transition: all 0.15s;
        text-decoration: none;
    }

    .btn-card svg {
        width: 0.875rem;
        height: 0.875rem;
    }

    .btn-card-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-card-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .modification-badge {
        font-size: 0.6875rem;
        font-weight: 600;
        color: #9a3412;
        background: #fed7aa;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        white-space: nowrap;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-icon {
        width: 4rem;
        height: 4rem;
        color: #d1d5db;
        margin: 0 auto 1.5rem auto;
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.5rem;
    }

    .empty-description {
        font-size: 0.9375rem;
        color: #6b7280;
        margin-bottom: 2rem;
    }

    .empty-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .empty-actions .btn-primary,
    .empty-actions .btn-secondary {
        padding: 0.75rem 1.5rem;
        font-size: 0.9375rem;
        font-weight: 600;
        border-radius: 0.5rem;
        text-decoration: none;
        transition: all 0.15s;
    }

    .empty-actions .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .empty-actions .btn-primary:hover {
        background: #2563eb;
    }

    .empty-actions .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .empty-actions .btn-secondary:hover {
        background: #4b5563;
    }
    </style>

    <script>
    // Load color thresholds from API
    let colorThresholds = {
        green: 8,
        yellow: 4,
        red: 2
    };

    async function loadColorThresholds() {
        try {
            const response = await fetch('{{ url_for("admin.get_color_thresholds_api") }}');
            const data = await response.json();

            colorThresholds = {
                green: data.green_threshold_hours,
                yellow: data.yellow_threshold_hours,
                red: data.red_threshold_hours
            };
            console.log('Umbrales de colores cargados:', colorThresholds);
        } catch (error) {
            console.error('Error al cargar umbrales de colores:', error);
            // Usar valores por defecto si hay error
            colorThresholds = { green: 8, yellow: 4, red: 2 };
        }
    }

    function updateCountdowns() {
        const now = new Date();

        document.querySelectorAll('[data-countdown-target]').forEach(countdownEl => {
            const card = countdownEl.closest('.patient-card');
            const fpaIso = card.dataset.fpa;

            if (!fpaIso) return;

            const fpaDate = new Date(fpaIso);
            const timeDiff = fpaDate - now;

            if (timeDiff <= 0) {
                countdownEl.querySelector('.countdown-time').textContent = 'VENCIDO';
                countdownEl.classList.remove('countdown-normal', 'countdown-warning', 'countdown-critical');
                countdownEl.classList.add('countdown-expired');
                return;
            }

            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

            let display = '';
            const totalHours = days * 24 + hours;

            if (days > 0) {
                display = `${days}d ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            countdownEl.querySelector('.countdown-time').textContent = display;

            // Update urgency class dynamically using configurable thresholds
            countdownEl.classList.remove('countdown-normal', 'countdown-warning', 'countdown-critical');

            // Ensure colorThresholds exists
            const thresholds = colorThresholds || { green: 8, yellow: 4, red: 2 };

            if (totalHours < thresholds.red) {
                countdownEl.classList.add('countdown-critical');
            } else if (totalHours < thresholds.yellow) {
                countdownEl.classList.add('countdown-warning');
            } else if (totalHours < thresholds.green) {
                countdownEl.classList.add('countdown-warning');
            } else {
                countdownEl.classList.add('countdown-normal');
            }
        });
    }

    // EDITABLE ROOM - INLINE EDITING
    function updateScheduledCountdowns() {
        const now = new Date();

        document.querySelectorAll('[data-scheduled-fpa]').forEach(el => {
            const fpaIso = el.dataset.scheduledFpa;
            if (!fpaIso) return;

            const fpaDate = new Date(fpaIso);
            const timeDiff = fpaDate - now;

            if (timeDiff <= 0) {
                el.textContent = 'Ticket ya activo';
                el.classList.add('text-green-600');
                return;
            }

            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

            let display = 'Activo en: ';

            if (days > 0) {
                display += `${days}d ${hours}h`;
            } else if (hours > 0) {
                display += `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                display += `${minutes}m`;
            } else {
                display = 'Activo en menos de un minuto';
            }

            el.textContent = display;
        });
    }

    // REAL-TIME SEARCH (filter as you type)
    const searchInput = document.querySelector('input[name="search"]');
    const cards = document.querySelectorAll('.patient-card');

    if (searchInput && cards.length > 0) {
        let searchTimeout;

        searchInput.addEventListener('input', function (e) {
            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();

                if (!searchTerm) {
                    // Show all cards
                    cards.forEach(card => {
                        card.style.display = '';
                    });
                    return;
                }

                // Filter cards
                cards.forEach(card => {
                    const cardText = card.textContent.toLowerCase();

                    if (cardText.includes(searchTerm)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }, 300); // Debounce 300ms
        });
    }

    document.addEventListener('DOMContentLoaded', async function () {
        // Load color thresholds first
        await loadColorThresholds();

        // Countdown updates
        updateCountdowns();
        setInterval(updateCountdowns, 1000);

        // Scheduled countdown updates
        updateScheduledCountdowns();
        setInterval(updateScheduledCountdowns, 60000); // Update every minute

        // Setup inline editing for room badges
        // Setup inline editing for bed and location fields (Issue #49)
        document.querySelectorAll('.editable-field').forEach(field => {
            const display = field.querySelector('.field-display');
            const input = field.querySelector('.field-input');
            const ticketId = field.dataset.ticketId;
            const fieldName = field.dataset.field; // 'bed_number' or 'location'

            // Click to edit
            field.addEventListener('click', function (e) {
                if (field.classList.contains('editing')) return;

                field.classList.add('editing');
                display.style.display = 'none';
                input.style.display = 'inline-block';
                input.focus();
                input.select();
            });

            const exitEditMode = function () {
                field.classList.remove('editing');
                display.style.display = 'inline';
                input.style.display = 'none';
            };

            // Save on Enter or blur
            const saveField = async function () {
                const newValue = input.value.trim();
                const currentValue = field.dataset.currentValue;

                // If no change, just exit edit mode
                if (newValue === currentValue) {
                    exitEditMode();
                    return;
                }

                // Make AJAX request to update the field
                try {
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

                    // Use the existing API endpoint
                    const response = await fetch('{{ url_for("tickets.api_update_bed_location") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            ticket_id: ticketId,
                            field: fieldName,
                            value: newValue
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update display
                        display.textContent = newValue || '-';
                        field.dataset.currentValue=newValue;

                        // Visual feedback
                        field.style.background = '#d4edda';

                        setTimeout(() => {
                            field.style.background = '';
                        }, 1000);
                    } else {
                        alert('Error: ' + (data.error || 'No se pudo actualizar'));
                        input.value = currentValue;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al guardar');
                    input.value = currentValue;
                }

                exitEditMode();
            };

            // Enter key to save
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveField();
                } else if (e.key === 'Escape') {
                    input.value = field.dataset.currentValue;
                    exitEditMode();
                }
            });

            // Blur to save
            input.addEventListener('blur', function () {
                setTimeout(saveField, 100);
            });

            // Prevent card click when editing
            input.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        });
    });
    </script>
{% endblock %}
