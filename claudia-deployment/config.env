#!/bin/bash
# ============================================
# CONFIGURACI√ìN DE DEPLOYMENT - AMBIENTE CLAUDIA
# ============================================
#
# INSTRUCCIONES:
# 1. Copia este archivo y ren√≥mbralo a 'config.local.env'
# 2. Completa TODAS las variables seg√∫n tu ambiente
# 3. NO commitees config.local.env (est√° en .gitignore)
#
# ============================================

# ============================================
# PROYECTO GCP
# ============================================
export GCP_PROJECT_ID="claudia-ticket-home-XXXXX"           # ID de tu proyecto GCP
export GCP_REGION="southamerica-west1"                       # Regi√≥n principal
export GCP_ZONE="southamerica-west1-a"                       # Zona espec√≠fica

# ============================================
# APLICACI√ìN
# ============================================
export APP_NAME="ticket-home"                                # Nombre de la aplicaci√≥n
export SERVICE_NAME="ticket-home"                            # Nombre del servicio Cloud Run
export ENVIRONMENT="claudia"                                 # Ambiente (claudia, dev, qa, prod)

# ============================================
# DOMINIO Y DNS
# ============================================
export DOMAIN_NAME="claudia-ticket-home.mhwdev.dev"         # Dominio completo
export RESERVED_IP_NAME="${SERVICE_NAME}-ip"                 # Nombre de la IP reservada
# La IP se obtendr√° despu√©s de reservarla

# ============================================
# CLOUD SQL (INSTANCIA EXISTENTE)
# ============================================
export CLOUDSQL_INSTANCE_NAME="ticket-home-sql-instance"    # Nombre de tu instancia Cloud SQL EXISTENTE
export CLOUDSQL_INSTANCE_CONNECTION_NAME="${GCP_PROJECT_ID}:${GCP_REGION}:${CLOUDSQL_INSTANCE_NAME}"

# CONEXI√ìN V√çA IP P√öBLICA
export CLOUDSQL_PUBLIC_IP=""                                 # IP p√∫blica de Cloud SQL (la obtendr√°s con: gcloud sql instances describe)
export CLOUDSQL_PORT="5432"                                  # Puerto PostgreSQL

# NUEVA BASE DE DATOS A CREAR
export DB_NAME="claudia_ticket_home"                         # Nombre de la nueva base de datos
export DB_USER="claudia_user"                                # Usuario de la base de datos
export DB_PASSWORD=""                                        # ‚ö†Ô∏è Debes generar una contrase√±a segura

# URL DE CONEXI√ìN (se construye autom√°ticamente)
export DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${CLOUDSQL_PUBLIC_IP}:${CLOUDSQL_PORT}/${DB_NAME}"

# ============================================
# DOCKER & ARTIFACT REGISTRY
# ============================================
export ARTIFACT_REGISTRY_REGION="us-central1"               # Regi√≥n de Artifact Registry
export ARTIFACT_REGISTRY_REPO="tickethome-repo"             # Nombre del repositorio
export IMAGE_NAME="${ARTIFACT_REGISTRY_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${APP_NAME}"
export IMAGE_TAG="latest"                                    # Tag de la imagen

# ============================================
# SECRETS EN SECRET MANAGER
# ============================================
# Nombres de los secrets (se crear√°n en Secret Manager)
export SECRET_DATABASE_URL_NAME="claudia-database-url"
export SECRET_KEY_NAME="claudia-secret-key"
export SECRET_SUPERUSER_EMAILS_NAME="claudia-superuser-emails"

# Valores de los secrets (‚ö†Ô∏è COMPLETAR)
export SECRET_KEY=""                                         # ‚ö†Ô∏è Generar con: python -c "import secrets; print(secrets.token_hex(32))"
export SUPERUSER_EMAILS="admin@example.com;tu.email@gmail.com"  # Lista separada por ;

# ============================================
# OAUTH 2.0 (IAP)
# ============================================
# Se crear√°n manualmente en GCP Console
export OAUTH_CLIENT_ID=""                                    # ‚ö†Ô∏è Completar despu√©s de crear OAuth Client
export OAUTH_CLIENT_SECRET=""                                # ‚ö†Ô∏è Completar despu√©s de crear OAuth Client

# URIs de Redirecci√≥n OAuth (se usar√°n al crear el cliente OAuth)
export OAUTH_REDIRECT_URI="https://iap.googleapis.com/v1/oauth/clientIds/YOUR_CLIENT_ID:handleRedirect"

# ============================================
# GOOGLE GROUPS (AUTORIZACI√ìN IAP)
# ============================================
export IAP_ACCESS_GROUP="claudia-ticket-home@googlegroups.com"  # Google Group con acceso

# ============================================
# CLOUD RUN - CONFIGURACI√ìN
# ============================================
export CLOUD_RUN_MIN_INSTANCES="0"                           # M√≠nimo de instancias (0 = escala a cero)
export CLOUD_RUN_MAX_INSTANCES="3"                           # M√°ximo de instancias
export CLOUD_RUN_MEMORY="1Gi"                                # Memoria asignada
export CLOUD_RUN_CPU="2"                                     # CPUs asignadas
export CLOUD_RUN_TIMEOUT="900"                               # Timeout en segundos (15 min)
export CLOUD_RUN_CONCURRENCY="80"                            # Requests concurrentes por instancia
export CLOUD_RUN_PORT="8080"                                 # Puerto de la aplicaci√≥n

# ============================================
# VARIABLES DE ENTORNO DE LA APLICACI√ìN
# ============================================
export FLASK_ENV="production"
export FLASK_DEBUG="false"
export ENABLE_IAP="true"                                     # IAP habilitado
export ENABLE_DEMO_LOGIN="true"                              # Login demo habilitado (false en producci√≥n)
export RESET_DB_ON_STARTUP="false"                           # NO resetear DB en startup

# ============================================
# SERVICE ACCOUNT
# ============================================
export SERVICE_ACCOUNT_NAME="${SERVICE_NAME}-sa"
export SERVICE_ACCOUNT_EMAIL="${SERVICE_ACCOUNT_NAME}@${GCP_PROJECT_ID}.iam.gserviceaccount.com"

# ============================================
# LOAD BALANCER - COMPONENTES
# ============================================
export NEG_NAME="${SERVICE_NAME}-neg"                        # Network Endpoint Group
export BACKEND_SERVICE_NAME="${SERVICE_NAME}-backend"
export URL_MAP_NAME="${SERVICE_NAME}-url-map"
export SSL_CERT_NAME="${SERVICE_NAME}-ssl"
export HTTPS_PROXY_NAME="${SERVICE_NAME}-https-proxy"
export FORWARDING_RULE_NAME="${SERVICE_NAME}-forwarding-rule"

# ============================================
# VALIDACIONES
# ============================================

# Funci√≥n para validar configuraci√≥n
validate_config() {
    echo "üîç Validando configuraci√≥n..."

    local errors=0

    # Validar variables cr√≠ticas
    if [ -z "$GCP_PROJECT_ID" ] || [[ "$GCP_PROJECT_ID" == *"XXXXX"* ]]; then
        echo "‚ùå ERROR: GCP_PROJECT_ID no configurado"
        errors=$((errors + 1))
    fi

    if [ -z "$DB_PASSWORD" ]; then
        echo "‚ùå ERROR: DB_PASSWORD no configurado"
        errors=$((errors + 1))
    fi

    if [ -z "$SECRET_KEY" ]; then
        echo "‚ùå ERROR: SECRET_KEY no configurado"
        errors=$((errors + 1))
    fi

    if [ -z "$CLOUDSQL_PUBLIC_IP" ]; then
        echo "‚ö†Ô∏è  WARNING: CLOUDSQL_PUBLIC_IP no configurado (se debe obtener)"
    fi

    if [ -z "$OAUTH_CLIENT_ID" ]; then
        echo "‚ö†Ô∏è  WARNING: OAUTH_CLIENT_ID no configurado (se crear√° despu√©s)"
    fi

    if [ $errors -gt 0 ]; then
        echo ""
        echo "‚ùå Configuraci√≥n incompleta. Por favor completa las variables marcadas."
        return 1
    fi

    echo "‚úÖ Configuraci√≥n validada correctamente"
    return 0
}

# ============================================
# HELPERS
# ============================================

# Mostrar configuraci√≥n actual (sin passwords)
show_config() {
    echo "============================================"
    echo "CONFIGURACI√ìN ACTUAL"
    echo "============================================"
    echo "Proyecto GCP:     $GCP_PROJECT_ID"
    echo "Regi√≥n:           $GCP_REGION"
    echo "Ambiente:         $ENVIRONMENT"
    echo "Dominio:          $DOMAIN_NAME"
    echo "Cloud SQL:        $CLOUDSQL_INSTANCE_NAME"
    echo "Nueva DB:         $DB_NAME"
    echo "Service Account:  $SERVICE_ACCOUNT_EMAIL"
    echo "Image:            $IMAGE_NAME:$IMAGE_TAG"
    echo "============================================"
}

# Generar SECRET_KEY si no existe
generate_secret_key() {
    if [ -z "$SECRET_KEY" ]; then
        echo "üîê Generando SECRET_KEY..."
        export SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_hex(32))" 2>/dev/null || openssl rand -hex 32)
        echo "‚úÖ SECRET_KEY generado: $SECRET_KEY"
        echo ""
        echo "‚ö†Ô∏è  IMPORTANTE: Guarda este SECRET_KEY en config.local.env"
    fi
}

# ============================================
# NOTAS IMPORTANTES
# ============================================
#
# ANTES DE EJECUTAR EL DEPLOYMENT:
# 1. Copia este archivo a config.local.env
# 2. Completa TODAS las variables marcadas con ‚ö†Ô∏è
# 3. Genera SECRET_KEY con: python -c "import secrets; print(secrets.token_hex(32))"
# 4. Obt√©n la IP p√∫blica de Cloud SQL con: gcloud sql instances describe <INSTANCE_NAME>
# 5. Valida la configuraci√≥n ejecutando: source config.local.env && validate_config
#
# ============================================
