<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a de Deployment - Ticket Home (Ambiente Claudia)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: #4ade80;
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .content {
            padding: 40px;
        }

        .timeline {
            position: relative;
            padding-left: 50px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        }

        .phase {
            position: relative;
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .phase.completed {
            background: #f0fdf4;
            border-left-color: #4ade80;
        }

        .phase-marker {
            position: absolute;
            left: -38px;
            top: 25px;
            width: 40px;
            height: 40px;
            background: white;
            border: 4px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .phase.completed .phase-marker {
            background: #4ade80;
            border-color: #4ade80;
            color: white;
        }

        .phase.completed .phase-marker::after {
            content: '‚úì';
            font-size: 20px;
        }

        .phase-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .phase-title {
            font-size: 1.5em;
            color: #1e293b;
            font-weight: 600;
        }

        .phase-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .phase-content {
            margin-top: 20px;
        }

        .phase-content.collapsed {
            display: none;
        }

        .step {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .step-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .step-description {
            color: #475569;
            margin-bottom: 15px;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            position: relative;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .code-block::before {
            content: 'Bash';
            position: absolute;
            top: 5px;
            right: 10px;
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .copy-btn:hover {
            background: #2563eb;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }

        .success-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }

        .error-box {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }

        .icon {
            display: inline-block;
            margin-right: 8px;
        }

        .var-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .var-input label {
            font-weight: 600;
            min-width: 200px;
            color: #1e293b;
        }

        .var-input input {
            flex: 1;
            min-width: 250px;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: monospace;
        }

        .var-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-section {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .config-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        .btn-primary:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        footer {
            background: #1e293b;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .checklist-summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .checklist-summary h3 {
            color: #1e293b;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            header {
                padding: 20px;
            }

            header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .timeline {
                padding-left: 30px;
            }

            .var-input {
                flex-direction: column;
                align-items: flex-start;
            }

            .var-input label {
                min-width: auto;
            }

            .var-input input {
                width: 100%;
            }
        }

        .collapsible-code {
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-code.expanded {
            max-height: none;
        }

        .expand-code-btn {
            background: #475569;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .expand-code-btn:hover {
            background: #334155;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Gu√≠a de Deployment</h1>
            <p>Ticket Home - Ambiente Claudia</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Cloud Run + Cloud SQL (IP P√∫blica) + IAP + SSL</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </header>

        <div class="content">
            <!-- Configuraci√≥n Inicial -->
            <div class="config-section">
                <div class="config-title">‚öôÔ∏è Configuraci√≥n de Variables</div>
                <div class="info-box">
                    <strong>üìù Instrucciones:</strong> Completa estas variables antes de comenzar. Ser√°n usadas para generar los comandos autom√°ticamente.
                </div>

                <div class="var-input">
                    <label>GCP Project ID:</label>
                    <input type="text" id="gcpProject" placeholder="claudia-ticket-home-xxxxx" />
                </div>

                <div class="var-input">
                    <label>Regi√≥n GCP:</label>
                    <input type="text" id="gcpRegion" value="southamerica-west1" />
                </div>

                <div class="var-input">
                    <label>Dominio:</label>
                    <input type="text" id="domain" placeholder="claudia-ticket-home.mhwdev.dev" />
                </div>

                <div class="var-input">
                    <label>Nombre Instancia Cloud SQL:</label>
                    <input type="text" id="sqlInstance" placeholder="ticket-home-sql-instance" />
                </div>

                <div class="var-input">
                    <label>IP P√∫blica Cloud SQL:</label>
                    <input type="text" id="sqlPublicIp" placeholder="Se obtendr√° autom√°ticamente" />
                </div>

                <div class="var-input">
                    <label>Nombre Base de Datos:</label>
                    <input type="text" id="dbName" value="claudia_ticket_home" />
                </div>

                <div class="var-input">
                    <label>Usuario DB:</label>
                    <input type="text" id="dbUser" value="claudia_user" />
                </div>

                <div class="var-input">
                    <label>Password DB:</label>
                    <input type="password" id="dbPassword" placeholder="Genera una contrase√±a segura" />
                </div>

                <div class="var-input">
                    <label>Grupo Google (IAP):</label>
                    <input type="text" id="iapGroup" placeholder="claudia-ticket-home@googlegroups.com" />
                </div>

                <button class="btn-primary" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                <button class="btn-secondary" onclick="loadConfig()">üìÇ Cargar Configuraci√≥n</button>
                <button class="btn-secondary" onclick="exportCommands()">üìã Exportar Comandos</button>
            </div>

            <!-- Checklist Summary -->
            <div class="checklist-summary">
                <h3>üìä Resumen de Progreso</h3>
                <div id="checklistSummary"></div>
            </div>

            <!-- Timeline de Fases -->
            <div class="timeline">
                <!-- FASE 0: Prerequisitos -->
                <div class="phase" data-phase="0">
                    <div class="phase-marker">0</div>
                    <div class="phase-header" onclick="togglePhase(0)">
                        <div class="phase-title">Fase 0: Prerequisitos y Verificaci√≥n</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content">
                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="0-1" onchange="updateProgress()">
                                <span>1. Verificar gcloud CLI instalado</span>
                            </div>
                            <div class="step-description">
                                Verifica que tengas gcloud CLI instalado y configurado.
                            </div>
                            <div class="code-block">
                                <pre>gcloud --version
gcloud auth login
gcloud auth list</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="0-2" onchange="updateProgress()">
                                <span>2. Verificar Docker instalado</span>
                            </div>
                            <div class="step-description">
                                Docker es necesario para construir las im√°genes.
                            </div>
                            <div class="code-block">
                                <pre>docker --version
docker ps</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="0-3" onchange="updateProgress()">
                                <span>3. Configurar proyecto GCP</span>
                            </div>
                            <div class="step-description">
                                Establece el proyecto GCP como activo.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-0-3">gcloud config set project YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="0-4" onchange="updateProgress()">
                                <span>4. Habilitar APIs necesarias</span>
                            </div>
                            <div class="step-description">
                                Habilita todas las APIs de GCP necesarias para el proyecto.
                            </div>
                            <div class="code-block">
                                <pre>gcloud services enable \
    run.googleapis.com \
    compute.googleapis.com \
    artifactregistry.googleapis.com \
    sqladmin.googleapis.com \
    secretmanager.googleapis.com \
    iap.googleapis.com \
    cloudresourcemanager.googleapis.com</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="info-box" style="margin-top: 15px;">
                                <strong>‚è±Ô∏è Tiempo estimado:</strong> 2-3 minutos
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FASE 1: Cloud SQL -->
                <div class="phase" data-phase="1">
                    <div class="phase-marker">1</div>
                    <div class="phase-header" onclick="togglePhase(1)">
                        <div class="phase-title">Fase 1: Cloud SQL - Crear Base de Datos</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="info-box">
                            <strong>üéØ Objetivo:</strong> Crear una nueva base de datos en la instancia de Cloud SQL existente y configurar acceso v√≠a IP p√∫blica.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="1-1" onchange="updateProgress()">
                                <span>1. Verificar instancia Cloud SQL existente</span>
                            </div>
                            <div class="step-description">
                                Confirma que la instancia existe y obt√©n su informaci√≥n.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-1-1">gcloud sql instances describe YOUR_SQL_INSTANCE \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="1-2" onchange="updateProgress()">
                                <span>2. Obtener IP p√∫blica de Cloud SQL</span>
                            </div>
                            <div class="step-description">
                                Extrae la IP p√∫blica para configurar la conexi√≥n.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-1-2">gcloud sql instances describe YOUR_SQL_INSTANCE \
    --project=YOUR_PROJECT_ID \
    --format="value(ipAddresses[0].ipAddress)"</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="success-box" style="margin-top: 15px;">
                                <strong>üí° Tip:</strong> Copia esta IP y p√©gala en el campo "IP P√∫blica Cloud SQL" arriba.
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="1-3" onchange="updateProgress()">
                                <span>3. Crear usuario de base de datos</span>
                            </div>
                            <div class="step-description">
                                Crea un usuario espec√≠fico para esta base de datos.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-1-3">gcloud sql users create YOUR_DB_USER \
    --instance=YOUR_SQL_INSTANCE \
    --password=YOUR_DB_PASSWORD \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="warning-box" style="margin-top: 15px;">
                                <strong>‚ö†Ô∏è Seguridad:</strong> Usa una contrase√±a fuerte. Puedes generarla con: <code>openssl rand -base64 32</code>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="1-4" onchange="updateProgress()">
                                <span>4. Crear nueva base de datos</span>
                            </div>
                            <div class="step-description">
                                Crea la base de datos dentro de la instancia existente.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-1-4">gcloud sql databases create YOUR_DB_NAME \
    --instance=YOUR_SQL_INSTANCE \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="1-5" onchange="updateProgress()">
                                <span>5. Configurar IPs autorizadas (Importante)</span>
                            </div>
                            <div class="step-description">
                                Dado que usamos IP p√∫blica, debemos autorizar las IPs de Cloud Run.
                            </div>
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è Importante:</strong> Cloud Run usa un rango de IPs variables. La mejor pr√°ctica es:
                                <br><br>
                                <strong>Opci√≥n A (Recomendada):</strong> Usar Cloud SQL Proxy desde Cloud Run
                                <br>
                                <strong>Opci√≥n B:</strong> Permitir el rango de IPs de salida de Cloud Run en tu regi√≥n
                            </div>
                            <div class="info-box">
                                <strong>üìù Nota:</strong> Para esta gu√≠a, asumimos que configurar√°s las IPs autorizadas manualmente en la consola de GCP seg√∫n las IPs de salida de Cloud Run en tu regi√≥n.
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="1-6" onchange="updateProgress()">
                                <span>6. Verificar conexi√≥n (Opcional)</span>
                            </div>
                            <div class="step-description">
                                Prueba la conexi√≥n a la base de datos desde tu m√°quina local.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-1-6">psql "host=YOUR_SQL_PUBLIC_IP port=5432 dbname=YOUR_DB_NAME user=YOUR_DB_USER password=YOUR_DB_PASSWORD sslmode=require"</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="info-box" style="margin-top: 15px;">
                                <strong>üí° Prerequisito:</strong> Debes tener PostgreSQL client instalado localmente y tu IP debe estar en las IPs autorizadas.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FASE 2: Secret Manager -->
                <div class="phase" data-phase="2">
                    <div class="phase-marker">2</div>
                    <div class="phase-header" onclick="togglePhase(2)">
                        <div class="phase-title">Fase 2: Secret Manager - Crear Secrets</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="info-box">
                            <strong>üéØ Objetivo:</strong> Crear y configurar todos los secrets necesarios en Google Secret Manager.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="2-1" onchange="updateProgress()">
                                <span>1. Generar SECRET_KEY para Flask</span>
                            </div>
                            <div class="step-description">
                                Genera una clave secreta aleatoria y segura.
                            </div>
                            <div class="code-block">
                                <pre>python3 -c "import secrets; print(secrets.token_hex(32))"</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="warning-box" style="margin-top: 15px;">
                                <strong>‚ö†Ô∏è Importante:</strong> Guarda este valor, lo necesitar√°s en el siguiente paso.
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="2-2" onchange="updateProgress()">
                                <span>2. Crear secret para DATABASE_URL</span>
                            </div>
                            <div class="step-description">
                                La URL de conexi√≥n a la base de datos.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-2-2">echo -n "postgresql://YOUR_DB_USER:YOUR_DB_PASSWORD@YOUR_SQL_PUBLIC_IP:5432/YOUR_DB_NAME?sslmode=require" | \
gcloud secrets create claudia-database-url \
    --data-file=- \
    --replication-policy=automatic \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="2-3" onchange="updateProgress()">
                                <span>3. Crear secret para SECRET_KEY</span>
                            </div>
                            <div class="step-description">
                                La clave secreta de Flask generada anteriormente.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-2-3">echo -n "YOUR_SECRET_KEY_HERE" | \
gcloud secrets create claudia-secret-key \
    --data-file=- \
    --replication-policy=automatic \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="2-4" onchange="updateProgress()">
                                <span>4. Crear secret para SUPERUSER_EMAILS</span>
                            </div>
                            <div class="step-description">
                                Lista de emails de superusuarios separados por punto y coma.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-2-4">echo -n "admin@example.com;tu.email@gmail.com" | \
gcloud secrets create claudia-superuser-emails \
    --data-file=- \
    --replication-policy=automatic \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="2-5" onchange="updateProgress()">
                                <span>5. Verificar secrets creados</span>
                            </div>
                            <div class="step-description">
                                Lista todos los secrets para confirmar que se crearon correctamente.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-2-5">gcloud secrets list --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>
                    </div>
                </div>

                <!-- FASE 3: Service Account -->
                <div class="phase" data-phase="3">
                    <div class="phase-marker">3</div>
                    <div class="phase-header" onclick="togglePhase(3)">
                        <div class="phase-title">Fase 3: Service Account y Permisos</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="info-box">
                            <strong>üéØ Objetivo:</strong> Crear Service Account con los permisos necesarios para Cloud Run, Cloud SQL y Secret Manager.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="3-1" onchange="updateProgress()">
                                <span>1. Crear Service Account</span>
                            </div>
                            <div class="step-description">
                                Cuenta de servicio que usar√° Cloud Run.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-3-1">gcloud iam service-accounts create ticket-home-sa \
    --display-name="Service Account para Ticket Home" \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="3-2" onchange="updateProgress()">
                                <span>2. Dar permiso Cloud SQL Client</span>
                            </div>
                            <div class="step-description">
                                Permite que el Service Account se conecte a Cloud SQL.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-3-2">gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
    --member="serviceAccount:ticket-home-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/cloudsql.client" \
    --condition=None</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="3-3" onchange="updateProgress()">
                                <span>3. Dar permiso Secret Manager Accessor</span>
                            </div>
                            <div class="step-description">
                                Permite leer los secrets de Secret Manager.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-3-3">gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
    --member="serviceAccount:ticket-home-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor" \
    --condition=None</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="3-4" onchange="updateProgress()">
                                <span>4. Dar permisos espec√≠ficos a cada secret</span>
                            </div>
                            <div class="step-description">
                                Permisos granulares para cada secret (buena pr√°ctica de seguridad).
                            </div>
                            <div class="code-block">
                                <pre id="cmd-3-4"># DATABASE_URL
gcloud secrets add-iam-policy-binding claudia-database-url \
    --member="serviceAccount:ticket-home-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor" \
    --project=YOUR_PROJECT_ID

# SECRET_KEY
gcloud secrets add-iam-policy-binding claudia-secret-key \
    --member="serviceAccount:ticket-home-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor" \
    --project=YOUR_PROJECT_ID

# SUPERUSER_EMAILS
gcloud secrets add-iam-policy-binding claudia-superuser-emails \
    --member="serviceAccount:ticket-home-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor" \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="3-5" onchange="updateProgress()">
                                <span>5. Verificar Service Account</span>
                            </div>
                            <div class="step-description">
                                Confirma que el Service Account se cre√≥ correctamente.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-3-5">gcloud iam service-accounts list --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>
                    </div>
                </div>

                <!-- FASE 4: Artifact Registry & Docker -->
                <div class="phase" data-phase="4">
                    <div class="phase-marker">4</div>
                    <div class="phase-header" onclick="togglePhase(4)">
                        <div class="phase-title">Fase 4: Build y Push de Imagen Docker</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="info-box">
                            <strong>üéØ Objetivo:</strong> Construir la imagen Docker y subirla a Google Artifact Registry.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="4-1" onchange="updateProgress()">
                                <span>1. Crear repositorio en Artifact Registry</span>
                            </div>
                            <div class="step-description">
                                Crear repositorio para almacenar las im√°genes Docker (si no existe).
                            </div>
                            <div class="code-block">
                                <pre id="cmd-4-1">gcloud artifacts repositories create tickethome-repo \
    --repository-format=docker \
    --location=us-central1 \
    --description="Docker images para Ticket Home" \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="4-2" onchange="updateProgress()">
                                <span>2. Configurar autenticaci√≥n de Docker</span>
                            </div>
                            <div class="step-description">
                                Configura Docker para usar gcloud como credential helper.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-4-2">gcloud auth configure-docker us-central1-docker.pkg.dev --quiet</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="4-3" onchange="updateProgress()">
                                <span>3. Build de imagen Docker</span>
                            </div>
                            <div class="step-description">
                                Construye la imagen Docker para tu aplicaci√≥n.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-4-3">docker build \
    --platform linux/amd64 \
    --build-arg BUILD_VERSION="claudia" \
    -t us-central1-docker.pkg.dev/YOUR_PROJECT_ID/tickethome-repo/ticket-home:latest \
    .</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="info-box" style="margin-top: 15px;">
                                <strong>‚è±Ô∏è Tiempo estimado:</strong> 5-10 minutos dependiendo de tu conexi√≥n
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="4-4" onchange="updateProgress()">
                                <span>4. Push de imagen a Artifact Registry</span>
                            </div>
                            <div class="step-description">
                                Sube la imagen al registro de GCP.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-4-4">docker push us-central1-docker.pkg.dev/YOUR_PROJECT_ID/tickethome-repo/ticket-home:latest</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="info-box" style="margin-top: 15px;">
                                <strong>‚è±Ô∏è Tiempo estimado:</strong> 3-8 minutos
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="4-5" onchange="updateProgress()">
                                <span>5. Verificar imagen en Artifact Registry</span>
                            </div>
                            <div class="step-description">
                                Confirma que la imagen se subi√≥ correctamente.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-4-5">gcloud artifacts docker images list \
    us-central1-docker.pkg.dev/YOUR_PROJECT_ID/tickethome-repo \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>
                    </div>
                </div>

                <!-- FASE 5: Cloud Run Deployment -->
                <div class="phase" data-phase="5">
                    <div class="phase-marker">5</div>
                    <div class="phase-header" onclick="togglePhase(5)">
                        <div class="phase-title">Fase 5: Deployment en Cloud Run</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="info-box">
                            <strong>üéØ Objetivo:</strong> Desplegar la aplicaci√≥n en Cloud Run con todas las configuraciones necesarias.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="5-1" onchange="updateProgress()">
                                <span>1. Desplegar servicio en Cloud Run</span>
                            </div>
                            <div class="step-description">
                                Comando completo para desplegar a Cloud Run con todos los par√°metros.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-5-1">gcloud run deploy ticket-home \
    --image=us-central1-docker.pkg.dev/YOUR_PROJECT_ID/tickethome-repo/ticket-home:latest \
    --region=southamerica-west1 \
    --service-account=ticket-home-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com \
    --no-allow-unauthenticated \
    --ingress=internal-and-cloud-load-balancing \
    --port=8080 \
    --timeout=900 \
    --memory=1Gi \
    --cpu=2 \
    --min-instances=0 \
    --max-instances=3 \
    --concurrency=80 \
    --set-env-vars="ENVIRONMENT=claudia,FLASK_ENV=production,FLASK_DEBUG=false,ENABLE_IAP=true,ENABLE_DEMO_LOGIN=true,RESET_DB_ON_STARTUP=false" \
    --set-secrets="DATABASE_URL=claudia-database-url:latest,SECRET_KEY=claudia-secret-key:latest,SUPERUSER_EMAILS=claudia-superuser-emails:latest" \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="info-box" style="margin-top: 15px;">
                                <strong>‚è±Ô∏è Tiempo estimado:</strong> 3-5 minutos
                            </div>
                            <div class="warning-box" style="margin-top: 10px;">
                                <strong>‚ö†Ô∏è Importante:</strong> <code>--no-allow-unauthenticated</code> hace que el servicio sea privado. Solo ser√° accesible a trav√©s del Load Balancer con IAP.
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="5-2" onchange="updateProgress()">
                                <span>2. Obtener URL del servicio</span>
                            </div>
                            <div class="step-description">
                                Obt√©n la URL interna de Cloud Run (ser√° usada por el Load Balancer).
                            </div>
                            <div class="code-block">
                                <pre id="cmd-5-2">gcloud run services describe ticket-home \
    --region=southamerica-west1 \
    --project=YOUR_PROJECT_ID \
    --format="value(status.url)"</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="5-3" onchange="updateProgress()">
                                <span>3. Verificar logs de Cloud Run</span>
                            </div>
                            <div class="step-description">
                                Revisa los logs para confirmar que la aplicaci√≥n inici√≥ correctamente.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-5-3">gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=ticket-home" \
    --limit=20 \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>
                    </div>
                </div>

                <!-- FASE 6: Load Balancer -->
                <div class="phase" data-phase="6">
                    <div class="phase-marker">6</div>
                    <div class="phase-header" onclick="togglePhase(6)">
                        <div class="phase-title">Fase 6: Load Balancer con SSL</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="info-box">
                            <strong>üéØ Objetivo:</strong> Configurar Load Balancer global con certificado SSL administrado para exponer la aplicaci√≥n p√∫blicamente.
                        </div>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Pre-requisito importante:</strong> Antes de empezar esta fase, aseg√∫rate de tener acceso al DNS de tu dominio para crear un registro tipo A.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-1" onchange="updateProgress()">
                                <span>1. Reservar IP est√°tica global</span>
                            </div>
                            <div class="step-description">
                                Reserva una IP p√∫blica que ser√° el punto de entrada.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-1">gcloud compute addresses create ticket-home-ip \
    --global \
    --ip-version=IPV4 \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-2" onchange="updateProgress()">
                                <span>2. Obtener la IP reservada</span>
                            </div>
                            <div class="step-description">
                                Extrae la IP para configurar el DNS.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-2">gcloud compute addresses describe ticket-home-ip \
    --global \
    --project=YOUR_PROJECT_ID \
    --format="value(address)"</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="warning-box" style="margin-top: 15px;">
                                <strong>‚ö†Ô∏è Acci√≥n requerida:</strong> Configura un registro DNS tipo A apuntando <code id="domain-display">tu-dominio.com</code> a esta IP.
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-3" onchange="updateProgress()">
                                <span>3. Crear Network Endpoint Group (NEG)</span>
                            </div>
                            <div class="step-description">
                                Conecta Cloud Run con el Load Balancer.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-3">gcloud compute network-endpoint-groups create ticket-home-neg \
    --region=southamerica-west1 \
    --network-endpoint-type=serverless \
    --cloud-run-service=ticket-home \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-4" onchange="updateProgress()">
                                <span>4. Crear Backend Service</span>
                            </div>
                            <div class="step-description">
                                Servicio backend que enrutar√° las peticiones.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-4">gcloud compute backend-services create ticket-home-backend \
    --global \
    --enable-cdn \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-5" onchange="updateProgress()">
                                <span>5. Agregar NEG al Backend Service</span>
                            </div>
                            <div class="step-description">
                                Asocia el NEG con el backend service.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-5">gcloud compute backend-services add-backend ticket-home-backend \
    --global \
    --network-endpoint-group=ticket-home-neg \
    --network-endpoint-group-region=southamerica-west1 \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-6" onchange="updateProgress()">
                                <span>6. Crear certificado SSL administrado</span>
                            </div>
                            <div class="step-description">
                                Google provisionar√° autom√°ticamente un certificado SSL para tu dominio.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-6">gcloud compute ssl-certificates create ticket-home-ssl \
    --domains=YOUR_DOMAIN \
    --global \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="warning-box" style="margin-top: 15px;">
                                <strong>‚è±Ô∏è Importante:</strong> El certificado SSL puede tardar entre 15-60 minutos en aprovisionar. Debes tener el DNS configurado correctamente ANTES de este paso.
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-7" onchange="updateProgress()">
                                <span>7. Crear URL Map</span>
                            </div>
                            <div class="step-description">
                                Define el enrutamiento de las peticiones.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-7">gcloud compute url-maps create ticket-home-url-map \
    --default-service=ticket-home-backend \
    --global \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-8" onchange="updateProgress()">
                                <span>8. Crear HTTPS Proxy</span>
                            </div>
                            <div class="step-description">
                                Proxy que manejar√° las conexiones HTTPS.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-8">gcloud compute target-https-proxies create ticket-home-https-proxy \
    --url-map=ticket-home-url-map \
    --ssl-certificates=ticket-home-ssl \
    --global \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-9" onchange="updateProgress()">
                                <span>9. Crear Forwarding Rule (puerto 443)</span>
                            </div>
                            <div class="step-description">
                                Regla final que conecta la IP p√∫blica con todo el stack.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-9">gcloud compute forwarding-rules create ticket-home-forwarding-rule \
    --address=ticket-home-ip \
    --target-https-proxy=ticket-home-https-proxy \
    --global \
    --ports=443 \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="6-10" onchange="updateProgress()">
                                <span>10. Verificar estado del certificado SSL</span>
                            </div>
                            <div class="step-description">
                                Monitorea el provisionamiento del certificado.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-6-10">gcloud compute ssl-certificates describe ticket-home-ssl \
    --global \
    --project=YOUR_PROJECT_ID \
    --format="get(managed.status, managed.domainStatus)"</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="info-box" style="margin-top: 15px;">
                                <strong>‚úÖ Estado esperado:</strong> <code>ACTIVE</code> cuando est√© listo.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FASE 7: IAP (OAuth) -->
                <div class="phase" data-phase="7">
                    <div class="phase-marker">7</div>
                    <div class="phase-header" onclick="togglePhase(7)">
                        <div class="phase-title">Fase 7: IAP - Identity-Aware Proxy</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="info-box">
                            <strong>üéØ Objetivo:</strong> Configurar IAP para proteger la aplicaci√≥n con autenticaci√≥n de Google.
                        </div>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Importante:</strong> Esta fase incluye pasos MANUALES en la consola de GCP.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="7-1" onchange="updateProgress()">
                                <span>1. Configurar OAuth Consent Screen (MANUAL)</span>
                            </div>
                            <div class="step-description">
                                Configura la pantalla de consentimiento de OAuth 2.0.
                            </div>
                            <div class="code-block">
                                <pre># URL para configurar:
https://console.cloud.google.com/apis/credentials/consent?project=YOUR_PROJECT_ID

# Pasos:
# 1. Click en "CONFIGURAR PANTALLA DE CONSENTIMIENTO"
# 2. Tipo de usuario: "Externo"
# 3. Nombre de la aplicaci√≥n: "Ticket Home - Claudia"
# 4. Email de asistencia: tu email
# 5. Logo (opcional)
# 6. Dominios autorizados: mhwdev.dev (o tu dominio)
# 7. Informaci√≥n de contacto del desarrollador: tu email
# 8. GUARDAR Y CONTINUAR
# 9. √Åmbitos: dejar en blanco
# 10. GUARDAR Y CONTINUAR
# 11. Usuarios de prueba: agregar emails que tendr√°n acceso
# 12. GUARDAR Y CONTINUAR</pre>
                            </div>
                            <button class="btn-secondary" onclick="openUrl('https://console.cloud.google.com/apis/credentials/consent?project=' + document.getElementById('gcpProject').value)">üîó Abrir Consola OAuth</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="7-2" onchange="updateProgress()">
                                <span>2. Crear OAuth Client ID (MANUAL)</span>
                            </div>
                            <div class="step-description">
                                Crea las credenciales OAuth para IAP.
                            </div>
                            <div class="code-block">
                                <pre># URL para configurar:
https://console.cloud.google.com/apis/credentials?project=YOUR_PROJECT_ID

# Pasos:
# 1. Click en "+ CREAR CREDENCIALES"
# 2. Seleccionar "ID de cliente de OAuth 2.0"
# 3. Tipo de aplicaci√≥n: "Aplicaci√≥n web"
# 4. Nombre: "ticket-home-iap-client"
# 5. URIs de JavaScript autorizados: dejar vac√≠o
# 6. URIs de redirecci√≥n autorizados:
#    https://iap.googleapis.com/v1/oauth/clientIds/TU_CLIENT_ID:handleRedirect
#    (por ahora dejar vac√≠o, lo actualizaremos despu√©s)
# 7. CREAR
# 8. COPIAR el "ID de cliente" y "Secreto del cliente"</pre>
                            </div>
                            <button class="btn-secondary" onclick="openUrl('https://console.cloud.google.com/apis/credentials?project=' + document.getElementById('gcpProject').value)">üîó Abrir Consola Credenciales</button>

                            <div class="config-section" style="margin-top: 20px;">
                                <div class="config-title">üíæ Guardar credenciales OAuth</div>
                                <div class="var-input">
                                    <label>OAuth Client ID:</label>
                                    <input type="text" id="oauthClientId" placeholder="123456789-xxx.apps.googleusercontent.com" />
                                </div>
                                <div class="var-input">
                                    <label>OAuth Client Secret:</label>
                                    <input type="password" id="oauthClientSecret" placeholder="GOCSPX-xxxxx" />
                                </div>
                                <button class="btn-secondary" onclick="saveOAuthCreds()">üíæ Guardar</button>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="7-3" onchange="updateProgress()">
                                <span>3. Actualizar URI de redirecci√≥n OAuth</span>
                            </div>
                            <div class="step-description">
                                Ahora que tienes el Client ID, actualiza el URI de redirecci√≥n.
                            </div>
                            <div class="code-block">
                                <pre id="oauth-redirect-uri"># Vuelve a la consola de credenciales y edita el OAuth Client
# Agrega este URI de redirecci√≥n autorizado:
https://iap.googleapis.com/v1/oauth/clientIds/YOUR_CLIENT_ID:handleRedirect

# Reemplaza YOUR_CLIENT_ID con el Client ID que copiaste</pre>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="7-4" onchange="updateProgress()">
                                <span>4. Habilitar IAP en Backend Service</span>
                            </div>
                            <div class="step-description">
                                Activa IAP en el Backend Service del Load Balancer.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-7-4">gcloud iap web enable \
    --resource-type=backend-services \
    --service=ticket-home-backend \
    --oauth2-client-id=YOUR_OAUTH_CLIENT_ID \
    --oauth2-client-secret=YOUR_OAUTH_CLIENT_SECRET \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="7-5" onchange="updateProgress()">
                                <span>5. Configurar acceso IAP para el grupo</span>
                            </div>
                            <div class="step-description">
                                Da acceso a los usuarios del Google Group.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-7-5">gcloud iap web add-iam-policy-binding \
    --resource-type=backend-services \
    --service=ticket-home-backend \
    --member="group:YOUR_IAP_GROUP" \
    --role="roles/iap.httpsResourceAccessor" \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="7-6" onchange="updateProgress()">
                                <span>6. Crear Google Group (si no existe)</span>
                            </div>
                            <div class="step-description">
                                Crea el grupo de Google que tendr√° acceso a la aplicaci√≥n.
                            </div>
                            <div class="code-block">
                                <pre># URL para crear grupo:
https://groups.google.com/

# Pasos:
# 1. Crear nuevo grupo
# 2. Nombre: "Ticket Home - Claudia Users"
# 3. Email: claudia-ticket-home@googlegroups.com (o tu grupo)
# 4. Descripci√≥n: Usuarios con acceso a Ticket Home
# 5. Agregar miembros (emails que tendr√°n acceso)
# 6. Configurar como grupo de solo miembros</pre>
                            </div>
                            <button class="btn-secondary" onclick="openUrl('https://groups.google.com/')">üîó Abrir Google Groups</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="7-7" onchange="updateProgress()">
                                <span>7. Verificar configuraci√≥n de IAP</span>
                            </div>
                            <div class="step-description">
                                Confirma que IAP est√° habilitado correctamente.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-7-7">gcloud iap web get-iam-policy \
    --resource-type=backend-services \
    --service=ticket-home-backend \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>
                    </div>
                </div>

                <!-- FASE 8: Verificaci√≥n Final -->
                <div class="phase" data-phase="8">
                    <div class="phase-marker">8</div>
                    <div class="phase-header" onclick="togglePhase(8)">
                        <div class="phase-title">Fase 8: Verificaci√≥n y Testing</div>
                        <div class="phase-status">
                            <button class="toggle-btn">Expandir</button>
                        </div>
                    </div>
                    <div class="phase-content collapsed">
                        <div class="success-box">
                            <strong>üéâ ¬°Casi listo!</strong> Ahora vamos a verificar que todo est√© funcionando correctamente.
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="8-1" onchange="updateProgress()">
                                <span>1. Verificar DNS propagado</span>
                            </div>
                            <div class="step-description">
                                Confirma que el DNS apunta a la IP correcta.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-8-1">nslookup YOUR_DOMAIN

# O usar:
dig YOUR_DOMAIN +short</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="8-2" onchange="updateProgress()">
                                <span>2. Verificar certificado SSL activo</span>
                            </div>
                            <div class="step-description">
                                Revisa el estado del certificado SSL.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-8-2">gcloud compute ssl-certificates describe ticket-home-ssl \
    --global \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="success-box" style="margin-top: 15px;">
                                <strong>‚úÖ Esperado:</strong> <code>status: ACTIVE</code>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="8-3" onchange="updateProgress()">
                                <span>3. Test de acceso HTTPS</span>
                            </div>
                            <div class="step-description">
                                Prueba que el sitio responda por HTTPS.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-8-3">curl -I https://YOUR_DOMAIN</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                            <div class="success-box" style="margin-top: 15px;">
                                <strong>‚úÖ Esperado:</strong> HTTP/2 302 (redirect a IAP login)
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="8-4" onchange="updateProgress()">
                                <span>4. Test de autenticaci√≥n IAP</span>
                            </div>
                            <div class="step-description">
                                Accede con tu navegador y prueba el login de Google.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-8-4"># Abrir en navegador:
https://YOUR_DOMAIN

# Esperado:
# 1. Redirect a login de Google
# 2. Seleccionar cuenta
# 3. Dar consentimiento si es primera vez
# 4. Redirect a la aplicaci√≥n
# 5. Ver dashboard de Ticket Home</pre>
                            </div>
                            <button class="btn-primary" id="open-app-btn" onclick="openApp()">üåê Abrir Aplicaci√≥n</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="8-5" onchange="updateProgress()">
                                <span>5. Verificar logs de la aplicaci√≥n</span>
                            </div>
                            <div class="step-description">
                                Revisa que no haya errores en los logs de Cloud Run.
                            </div>
                            <div class="code-block">
                                <pre id="cmd-8-5">gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=ticket-home" \
    --limit=50 \
    --project=YOUR_PROJECT_ID \
    --format=json</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="8-6" onchange="updateProgress()">
                                <span>6. Test funcional: Crear ticket</span>
                            </div>
                            <div class="step-description">
                                Prueba la funcionalidad principal creando un ticket de prueba.
                            </div>
                            <div class="success-box">
                                <strong>‚úÖ Checklist funcional:</strong>
                                <ul style="margin-top: 10px; margin-left: 20px;">
                                    <li>Login exitoso con Google SSO ‚úì</li>
                                    <li>Dashboard carga correctamente ‚úì</li>
                                    <li>Crear nuevo ticket funciona ‚úì</li>
                                    <li>Lista de tickets se muestra ‚úì</li>
                                    <li>Editar ticket funciona ‚úì</li>
                                    <li>Eliminar ticket funciona ‚úì</li>
                                </ul>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <input type="checkbox" class="step-checkbox" data-step="8-7" onchange="updateProgress()">
                                <span>7. Verificar conexi√≥n a base de datos</span>
                            </div>
                            <div class="step-description">
                                Confirma que la aplicaci√≥n se est√° conectando correctamente a Cloud SQL.
                            </div>
                            <div class="code-block">
                                <pre># Buscar en los logs confirmaci√≥n de conexi√≥n DB:
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=ticket-home AND textPayload:'database'" \
    --limit=20 \
    --project=YOUR_PROJECT_ID</pre>
                            </div>
                            <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Botones de acci√≥n final -->
            <div style="text-align: center; margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
                <h2 style="color: white; margin-bottom: 20px;">üéâ ¬°Deployment Completado!</h2>
                <p style="color: white; margin-bottom: 20px;">Si todos los pasos est√°n marcados, tu aplicaci√≥n deber√≠a estar funcionando.</p>
                <button class="btn-primary" style="background: white; color: #667eea; margin: 10px;" onclick="downloadReport()">üìÑ Descargar Reporte</button>
                <button class="btn-primary" style="background: white; color: #667eea; margin: 10px;" onclick="resetProgress()">üîÑ Resetear Progreso</button>
            </div>
        </div>

        <footer>
            <p>Gu√≠a de Deployment - Ticket Home</p>
            <p style="margin-top: 10px; opacity: 0.8;">Ambiente: Claudia | Cloud Run + Cloud SQL + IAP + SSL</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Creado con ‚ù§Ô∏è por Claude Code</p>
        </footer>
    </div>

    <script>
        // Estado global
        const totalSteps = 49; // Total de checkboxes
        let config = {};

        // Cargar estado al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadProgress();
            loadConfig();
            updateAllCommands();
            updateProgress();
        });

        // Toggle fase
        function togglePhase(phaseNum) {
            const phase = document.querySelector(`[data-phase="${phaseNum}"]`);
            const content = phase.querySelector('.phase-content');
            const btn = phase.querySelector('.toggle-btn');

            content.classList.toggle('collapsed');
            btn.textContent = content.classList.contains('collapsed') ? 'Expandir' : 'Contraer';
        }

        // Actualizar progreso
        function updateProgress() {
            const checkboxes = document.querySelectorAll('.step-checkbox');
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percentage = (checked / totalSteps) * 100;

            document.getElementById('progressFill').style.width = percentage + '%';

            // Actualizar marcador de fases
            checkboxes.forEach(cb => {
                const stepId = cb.dataset.step;
                const phaseNum = parseInt(stepId.split('-')[0]);
                const phase = document.querySelector(`[data-phase="${phaseNum}"]`);

                // Guardar estado
                localStorage.setItem(`step-${stepId}`, cb.checked);

                // Verificar si toda la fase est√° completa
                const phaseCheckboxes = phase.querySelectorAll('.step-checkbox');
                const allChecked = Array.from(phaseCheckboxes).every(c => c.checked);

                if (allChecked) {
                    phase.classList.add('completed');
                } else {
                    phase.classList.remove('completed');
                }
            });

            updateChecklistSummary();
        }

        // Actualizar resumen
        function updateChecklistSummary() {
            const summary = document.getElementById('checklistSummary');
            const phases = document.querySelectorAll('.phase');

            let html = '';
            phases.forEach((phase, index) => {
                const checkboxes = phase.querySelectorAll('.step-checkbox');
                const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
                const total = checkboxes.length;
                const percentage = (checked / total) * 100;

                const status = percentage === 100 ? '‚úÖ' : percentage > 0 ? '‚è≥' : '‚¨ú';
                const color = percentage === 100 ? '#10b981' : percentage > 0 ? '#f59e0b' : '#94a3b8';

                html += `
                    <div class="summary-item">
                        <span>${status} Fase ${index}: ${phase.querySelector('.phase-title').textContent}</span>
                        <span style="color: ${color}; font-weight: 600;">${checked}/${total}</span>
                    </div>
                `;
            });

            summary.innerHTML = html;
        }

        // Guardar progreso
        function loadProgress() {
            const checkboxes = document.querySelectorAll('.step-checkbox');
            checkboxes.forEach(cb => {
                const stepId = cb.dataset.step;
                const saved = localStorage.getItem(`step-${stepId}`);
                if (saved === 'true') {
                    cb.checked = true;
                }
            });
        }

        // Copiar c√≥digo
        function copyCode(btn) {
            const codeBlock = btn.previousElementSibling;
            const code = codeBlock.textContent;

            navigator.clipboard.writeText(code).then(() => {
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copiado!';
                btn.style.background = '#10b981';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#3b82f6';
                }, 2000);
            });
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            config = {
                gcpProject: document.getElementById('gcpProject').value,
                gcpRegion: document.getElementById('gcpRegion').value,
                domain: document.getElementById('domain').value,
                sqlInstance: document.getElementById('sqlInstance').value,
                sqlPublicIp: document.getElementById('sqlPublicIp').value,
                dbName: document.getElementById('dbName').value,
                dbUser: document.getElementById('dbUser').value,
                dbPassword: document.getElementById('dbPassword').value,
                iapGroup: document.getElementById('iapGroup').value,
                oauthClientId: document.getElementById('oauthClientId')?.value || '',
                oauthClientSecret: document.getElementById('oauthClientSecret')?.value || ''
            };

            localStorage.setItem('deployment-config', JSON.stringify(config));
            updateAllCommands();

            alert('‚úÖ Configuraci√≥n guardada exitosamente!');
        }

        // Cargar configuraci√≥n
        function loadConfig() {
            const saved = localStorage.getItem('deployment-config');
            if (saved) {
                config = JSON.parse(saved);

                // Rellenar campos
                Object.keys(config).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = config[key];
                    }
                });
            }
        }

        // Actualizar todos los comandos con las variables
        function updateAllCommands() {
            if (!config.gcpProject) return;

            // Reemplazar en todos los elementos con id cmd-*
            document.querySelectorAll('[id^="cmd-"]').forEach(el => {
                let text = el.textContent;

                text = text.replace(/YOUR_PROJECT_ID/g, config.gcpProject);
                text = text.replace(/YOUR_SQL_INSTANCE/g, config.sqlInstance);
                text = text.replace(/YOUR_SQL_PUBLIC_IP/g, config.sqlPublicIp);
                text = text.replace(/YOUR_DB_NAME/g, config.dbName);
                text = text.replace(/YOUR_DB_USER/g, config.dbUser);
                text = text.replace(/YOUR_DB_PASSWORD/g, config.dbPassword);
                text = text.replace(/YOUR_DOMAIN/g, config.domain);
                text = text.replace(/YOUR_IAP_GROUP/g, config.iapGroup);
                text = text.replace(/YOUR_OAUTH_CLIENT_ID/g, config.oauthClientId);
                text = text.replace(/YOUR_OAUTH_CLIENT_SECRET/g, config.oauthClientSecret);
                text = text.replace(/southamerica-west1/g, config.gcpRegion);

                el.textContent = text;
            });

            // Actualizar display del dominio
            const domainDisplay = document.getElementById('domain-display');
            if (domainDisplay) {
                domainDisplay.textContent = config.domain;
            }

            // Actualizar OAuth redirect URI
            if (config.oauthClientId) {
                const redirectUri = document.getElementById('oauth-redirect-uri');
                if (redirectUri) {
                    let text = redirectUri.textContent;
                    text = text.replace(/YOUR_CLIENT_ID/g, config.oauthClientId);
                    redirectUri.textContent = text;
                }
            }
        }

        // Guardar credenciales OAuth
        function saveOAuthCreds() {
            const clientId = document.getElementById('oauthClientId').value;
            const clientSecret = document.getElementById('oauthClientSecret').value;

            if (!clientId || !clientSecret) {
                alert('‚ö†Ô∏è Por favor completa ambos campos');
                return;
            }

            config.oauthClientId = clientId;
            config.oauthClientSecret = clientSecret;

            localStorage.setItem('deployment-config', JSON.stringify(config));
            updateAllCommands();

            alert('‚úÖ Credenciales OAuth guardadas!');
        }

        // Abrir aplicaci√≥n
        function openApp() {
            const domain = config.domain || document.getElementById('domain').value;
            if (!domain) {
                alert('‚ö†Ô∏è Por favor configura el dominio primero');
                return;
            }
            window.open('https://' + domain, '_blank');
        }

        // Abrir URL
        function openUrl(url) {
            window.open(url, '_blank');
        }

        // Exportar comandos
        function exportCommands() {
            if (!config.gcpProject) {
                alert('‚ö†Ô∏è Por favor guarda la configuraci√≥n primero');
                return;
            }

            let commands = '#!/bin/bash\n';
            commands += '# Comandos de deployment generados autom√°ticamente\n';
            commands += '# Fecha: ' + new Date().toISOString() + '\n\n';

            commands += '# Configuraci√≥n\n';
            commands += `export GCP_PROJECT_ID="${config.gcpProject}"\n`;
            commands += `export GCP_REGION="${config.gcpRegion}"\n`;
            commands += `export DOMAIN="${config.domain}"\n\n`;

            // Extraer todos los comandos
            document.querySelectorAll('.code-block pre').forEach(el => {
                const cmd = el.textContent.trim();
                if (cmd && !cmd.startsWith('#') && !cmd.startsWith('https://')) {
                    commands += cmd + '\n\n';
                }
            });

            // Descargar
            const blob = new Blob([commands], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'deployment-commands.sh';
            a.click();
        }

        // Descargar reporte
        function downloadReport() {
            const checkboxes = document.querySelectorAll('.step-checkbox');
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;

            let report = 'REPORTE DE DEPLOYMENT - TICKET HOME\n';
            report += '=====================================\n\n';
            report += `Fecha: ${new Date().toLocaleString()}\n`;
            report += `Progreso: ${checked}/${totalSteps} pasos completados (${Math.round((checked/totalSteps)*100)}%)\n\n`;

            report += 'CONFIGURACI√ìN:\n';
            report += `- Proyecto GCP: ${config.gcpProject}\n`;
            report += `- Regi√≥n: ${config.gcpRegion}\n`;
            report += `- Dominio: ${config.domain}\n`;
            report += `- Instancia Cloud SQL: ${config.sqlInstance}\n`;
            report += `- Base de Datos: ${config.dbName}\n\n`;

            report += 'FASES COMPLETADAS:\n';
            document.querySelectorAll('.phase').forEach((phase, index) => {
                const phaseCheckboxes = phase.querySelectorAll('.step-checkbox');
                const phaseChecked = Array.from(phaseCheckboxes).filter(cb => cb.checked).length;
                const phaseTotal = phaseCheckboxes.length;
                const status = phaseChecked === phaseTotal ? '‚úÖ' : '‚è≥';

                report += `${status} Fase ${index}: ${phaseChecked}/${phaseTotal}\n`;
            });

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'deployment-report.txt';
            a.click();
        }

        // Resetear progreso
        function resetProgress() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de resetear todo el progreso?')) {
                return;
            }

            document.querySelectorAll('.step-checkbox').forEach(cb => {
                cb.checked = false;
                localStorage.removeItem(`step-${cb.dataset.step}`);
            });

            updateProgress();
            alert('‚úÖ Progreso reseteado');
        }
    </script>
</body>
</html>
