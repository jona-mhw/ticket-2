name: ğŸ­ Deploy to PRODUCTION

on:
  workflow_dispatch:  # Solo manual trigger
    inputs:
      confirm_production:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string
      version_tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  validate-input:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "âŒ Deployment cancelled. Confirmation text does not match."
            exit 1
          fi
          echo "âœ… Deployment confirmed"

  deploy-production:
    name: Deploy to PRODUCTION Environment
    runs-on: ubuntu-latest
    needs: validate-input
    environment:
      name: Production
      url: https://ticket-home.redsalud.cl

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker southamerica-west1-docker.pkg.dev

      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ github.event.inputs.version_tag }}
        run: |
          docker build -t southamerica-west1-docker.pkg.dev/tickethome-prod/ticket-home-repo/ticket-home-prod:${IMAGE_TAG} .
          docker build -t southamerica-west1-docker.pkg.dev/tickethome-prod/ticket-home-repo/ticket-home-prod:latest .

      - name: Push Docker image
        env:
          IMAGE_TAG: ${{ github.event.inputs.version_tag }}
        run: |
          docker push southamerica-west1-docker.pkg.dev/tickethome-prod/ticket-home-repo/ticket-home-prod:${IMAGE_TAG}
          docker push southamerica-west1-docker.pkg.dev/tickethome-prod/ticket-home-repo/ticket-home-prod:latest

      - name: Deploy to Cloud Run (PRODUCTION)
        env:
          IMAGE_TAG: ${{ github.event.inputs.version_tag }}
        run: |
          gcloud run deploy ticket-home-prod \
            --image southamerica-west1-docker.pkg.dev/tickethome-prod/ticket-home-repo/ticket-home-prod:${IMAGE_TAG} \
            --platform managed \
            --region southamerica-west1 \
            --allow-unauthenticated \
            --set-env-vars ENVIRONMENT=production,FLASK_ENV=production,ENABLE_IAP=true,ENABLE_DEMO_LOGIN=false,APP_VERSION=${IMAGE_TAG} \
            --set-secrets DATABASE_URL=tickethome-db-url-prod:latest,SECRET_KEY=tickethome-secret-key-prod:latest,SUPERUSER_EMAILS=superuser-emails:latest \
            --vpc-connector tckthome-conn-prod-sa-west1 \
            --min-instances 2 \
            --max-instances 10 \
            --cpu 4 \
            --memory 2Gi \
            --concurrency 100 \
            --timeout 900

      - name: Set IAP policy
        run: |
          gcloud run services add-iam-policy-binding ticket-home-prod \
            --region=southamerica-west1 \
            --member='group:ticket-home-prod@redsalud.cl' \
            --role='roles/run.invoker'

      - name: Get service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ticket-home-prod --region southamerica-west1 --format 'value(status.url)')
          echo "service_url=$URL" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version_tag }}
          release_name: Release ${{ github.event.inputs.version_tag }}
          body: |
            ## ğŸš€ Production Deployment

            **Version**: ${{ github.event.inputs.version_tag }}
            **Deployed**: ${{ github.event.repository.updated_at }}
            **Commit**: ${{ github.sha }}

            ### Changes
            See commit history for details.

            ### Deployment Info
            - **URL**: ${{ steps.get-url.outputs.service_url }}
            - **Image**: southamerica-west1-docker.pkg.dev/tickethome-prod/ticket-home-repo/ticket-home-prod:${{ github.event.inputs.version_tag }}
          draft: false
          prerelease: false

      - name: Deployment summary
        run: |
          echo "âœ… PRODUCTION deployment successful!"
          echo "ğŸ”— URL: ${{ steps.get-url.outputs.service_url }}"
          echo "ğŸ·ï¸ Version: ${{ github.event.inputs.version_tag }}"
          echo "ğŸ“¦ Image: southamerica-west1-docker.pkg.dev/tickethome-prod/ticket-home-repo/ticket-home-prod:${{ github.event.inputs.version_tag }}"

      - name: Notify Slack (optional)
        if: success()
        run: |
          echo "ğŸ“¢ Consider adding Slack notification here"
          # curl -X POST -H 'Content-type: application/json' \
          #   --data "{\"text\":\"âœ… Ticket Home ${{ github.event.inputs.version_tag }} deployed to PRODUCTION\"}" \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
