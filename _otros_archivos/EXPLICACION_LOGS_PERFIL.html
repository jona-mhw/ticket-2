<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explicaci√≥n: Validaci√≥n de Logs por Perfil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .section h3 {
            color: #555;
            margin: 20px 0 10px 0;
            font-size: 1.2em;
        }

        .scenario {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scenario h4 {
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-superuser {
            background: #dc3545;
            color: white;
        }

        .badge-admin {
            background: #ffc107;
            color: #333;
        }

        .badge-clinical {
            background: #17a2b8;
            color: white;
        }

        .badge-visualizador {
            background: #6c757d;
            color: white;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #0c5460;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #856404;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border-color: #155724;
            color: #155724;
        }

        .example-log {
            background: #f8f9fa;
            padding: 10px;
            border-left: 3px solid #28a745;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .rules-box {
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        ul, ol {
            padding-left: 25px;
        }

        li {
            margin: 8px 0;
        }

        .visual-flow {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 25px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .flow-box {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .flow-arrow {
            font-size: 2em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã Validaci√≥n de Logs de Acceso por Perfil</h1>
            <p>Sistema Ticket Home - Auditor√≠a Multi-tenant</p>
        </header>

        <div class="content">
            <!-- PROBLEMA -->
            <div class="section">
                <h2>üéØ El Problema a Resolver</h2>
                <p style="font-size: 1.05em;">
                    Actualmente, el sistema registra TODOS los accesos en las tablas <code>LoginAudit</code> y
                    <code>ActionAudit</code>, pero <strong>no existe validaci√≥n autom√°tica</strong> de que los logs
                    se est√©n filtrando correctamente seg√∫n el perfil del usuario.
                </p>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Riesgo:</strong> Un bug en el c√≥digo podr√≠a hacer que:
                    <ul style="margin-top: 10px;">
                        <li>Un Admin vea logs de otras cl√≠nicas</li>
                        <li>Un Superusuario no vea el campo <code>clinic_id</code> correctamente</li>
                        <li>Logs importantes no se registren por errores en la l√≥gica</li>
                    </ul>
                </div>
            </div>

            <!-- PERFILES DE USUARIO -->
            <div class="section">
                <h2>üë• Perfiles de Usuario en Ticket Home</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Perfil</th>
                            <th>clinic_id</th>
                            <th>Qu√© Debe Ver en Logs</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-superuser">Superusuario</span></td>
                            <td><code>NULL</code></td>
                            <td><strong>TODOS</strong> los logs de todas las cl√≠nicas + campo clinic_id visible</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-admin">Admin</span></td>
                            <td><code>1</code> (ej: Providencia)</td>
                            <td><strong>SOLO</strong> logs de su cl√≠nica (clinic_id = 1)</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-clinical">Clinical</span></td>
                            <td><code>2</code> (ej: Vitacura)</td>
                            <td><strong>SOLO</strong> logs de su cl√≠nica (clinic_id = 2)</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-visualizador">Visualizador</span></td>
                            <td><code>3</code> (ej: Elqui)</td>
                            <td><strong>SOLO</strong> logs de su cl√≠nica (clinic_id = 3) + solo lectura</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- REGLAS DE NEGOCIO -->
            <div class="section">
                <h2>üìè Reglas de Negocio para Logs</h2>

                <div class="rules-box">
                    <h3>üî¥ Regla 1: Superusuario</h3>
                    <ul>
                        <li><strong>Ve:</strong> Todos los logs del sistema (LoginAudit + ActionAudit)</li>
                        <li><strong>Campo clinic_id:</strong> DEBE mostrarse en la UI para saber qu√© cl√≠nica</li>
                        <li><strong>Filtros:</strong> Puede filtrar por cl√≠nica espec√≠fica</li>
                        <li><strong>Ejemplo:</strong> Debe ver logins de Providencia, Vitacura, Elqui, etc.</li>
                    </ul>
                </div>

                <div class="rules-box">
                    <h3>üü° Regla 2: Admin de Cl√≠nica</h3>
                    <ul>
                        <li><strong>Ve:</strong> SOLO logs de su cl√≠nica (WHERE clinic_id = current_user.clinic_id)</li>
                        <li><strong>Campo clinic_id:</strong> No necesita mostrarse (siempre es la misma)</li>
                        <li><strong>Isolation:</strong> NO debe ver ning√∫n log de otras cl√≠nicas</li>
                        <li><strong>Ejemplo:</strong> Admin de Providencia solo ve logs de Providencia</li>
                    </ul>
                </div>

                <div class="rules-box">
                    <h3>üîµ Regla 3: Clinical/Visualizador</h3>
                    <ul>
                        <li><strong>Ve:</strong> Seg√∫n permisos (generalmente NO tienen acceso a auditor√≠a)</li>
                        <li><strong>Si tienen acceso:</strong> Solo logs de su cl√≠nica</li>
                        <li><strong>Isolation:</strong> Misma l√≥gica que Admin</li>
                    </ul>
                </div>
            </div>

            <!-- ESCENARIOS DE PRUEBA -->
            <div class="section">
                <h2>üß™ Escenarios de Prueba a Validar</h2>

                <div class="scenario">
                    <h4>üìù Escenario 1: Login de Superusuario</h4>
                    <strong>Given:</strong> Usuario super@test.com (Superusuario, clinic_id = NULL)<br>
                    <strong>When:</strong> Hace login exitoso<br>
                    <strong>Then:</strong>
                    <ul>
                        <li>Se crea registro en LoginAudit con user_id, clinic_id=NULL</li>
                        <li>Superusuario visita /admin/audit/logins</li>
                        <li>Ve TODOS los logins de TODAS las cl√≠nicas</li>
                        <li>Columna "Cl√≠nica" muestra el nombre de cada cl√≠nica</li>
                    </ul>

                    <div class="example-log">
                        LoginAudit.create(user_id=1, clinic_id=NULL, username='super@test.com', timestamp=now)
                    </div>
                </div>

                <div class="scenario">
                    <h4>üìù Escenario 2: Login de Admin de Cl√≠nica</h4>
                    <strong>Given:</strong> Usuario admin@providencia.cl (Admin, clinic_id = 1)<br>
                    <strong>When:</strong> Hace login exitoso<br>
                    <strong>Then:</strong>
                    <ul>
                        <li>Se crea registro en LoginAudit con user_id, clinic_id=1</li>
                        <li>Admin visita /admin/audit/logins</li>
                        <li>Ve SOLO logins de clinic_id=1 (Providencia)</li>
                        <li>NO ve logins de clinic_id=2, 3, 4, etc.</li>
                    </ul>

                    <div class="example-log">
                        LoginAudit.create(user_id=5, clinic_id=1, username='admin@providencia.cl', timestamp=now)
                    </div>
                </div>

                <div class="scenario">
                    <h4>üìù Escenario 3: Acci√≥n de Usuario Clinical</h4>
                    <strong>Given:</strong> Usuario clinical@vitacura.cl (Clinical, clinic_id = 2)<br>
                    <strong>When:</strong> Crea un ticket<br>
                    <strong>Then:</strong>
                    <ul>
                        <li>Se crea registro en ActionAudit con user_id, clinic_id=2, action='create_ticket'</li>
                        <li>Admin de Vitacura ve esta acci√≥n en /admin/audit/actions</li>
                        <li>Admin de Providencia NO la ve</li>
                        <li>Superusuario S√ç la ve (con clinic_id=2 visible)</li>
                    </ul>

                    <div class="example-log">
                        ActionAudit.create(user_id=8, clinic_id=2, action='create_ticket', target_id='TH-VIT-2025-001')
                    </div>
                </div>

                <div class="scenario">
                    <h4>üìù Escenario 4: Superusuario Filtra por Cl√≠nica</h4>
                    <strong>Given:</strong> Superusuario logueado<br>
                    <strong>When:</strong> Aplica filtro "Cl√≠nica: Providencia" en audit logs<br>
                    <strong>Then:</strong>
                    <ul>
                        <li>Ve SOLO logs donde clinic_id=1</li>
                        <li>Puede cambiar filtro a "Todas" y ver todo de nuevo</li>
                    </ul>
                </div>
            </div>

            <!-- FLUJO VISUAL -->
            <div class="section">
                <h2>üîÑ Flujo de Validaci√≥n Visual</h2>

                <h3>Superusuario</h3>
                <div class="visual-flow">
                    <div class="flow-box">
                        <strong>Login como Super</strong><br>
                        <small>clinic_id = NULL</small>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-box">
                        <strong>Ver /admin/audit/logins</strong><br>
                        <small>Query: SELECT * FROM login_audit</small>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-box">
                        <strong>‚úÖ Ver TODOS los logs</strong><br>
                        <small>Con columna "Cl√≠nica"</small>
                    </div>
                </div>

                <h3>Admin de Cl√≠nica</h3>
                <div class="visual-flow">
                    <div class="flow-box">
                        <strong>Login como Admin</strong><br>
                        <small>clinic_id = 1</small>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-box">
                        <strong>Ver /admin/audit/logins</strong><br>
                        <small>Query: WHERE clinic_id = 1</small>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-box">
                        <strong>‚úÖ Ver SOLO su cl√≠nica</strong><br>
                        <small>Isolation garantizado</small>
                    </div>
                </div>
            </div>

            <!-- IMPLEMENTACI√ìN -->
            <div class="section">
                <h2>üîß C√≥mo Implementar la Validaci√≥n</h2>

                <h3>Opci√≥n 1: Tests Automatizados (Recomendado)</h3>
                <div class="code-block">
# tests/test_audit_logs.py

def test_superuser_sees_all_logs(client, db, superuser, admin_prov, admin_vita):
    # Crear logs de diferentes cl√≠nicas
    LoginAudit.create(user=admin_prov, clinic_id=1)
    LoginAudit.create(user=admin_vita, clinic_id=2)

    # Login como superusuario
    login_as(superuser)

    # Ver p√°gina de logs
    response = client.get('/admin/audit/logins')

    # DEBE ver logs de TODAS las cl√≠nicas
    assert 'admin_prov' in response.data
    assert 'admin_vita' in response.data
    assert response.data.count('clinic_id') >= 2  # Columna visible


def test_admin_only_sees_own_clinic_logs(client, db, admin_prov, admin_vita):
    # Crear logs de diferentes cl√≠nicas
    LoginAudit.create(user=admin_prov, clinic_id=1)
    LoginAudit.create(user=admin_vita, clinic_id=2)

    # Login como admin de Providencia
    login_as(admin_prov)

    # Ver p√°gina de logs
    response = client.get('/admin/audit/logins')

    # DEBE ver solo su cl√≠nica
    assert 'admin_prov' in response.data
    assert 'admin_vita' NOT in response.data


def test_action_audit_multi_tenancy(client, db, admin_prov, admin_vita):
    # Crear acciones de diferentes cl√≠nicas
    ActionAudit.create(user=admin_prov, clinic_id=1, action='create_ticket')
    ActionAudit.create(user=admin_vita, clinic_id=2, action='modify_fpa')

    # Login como admin de Providencia
    login_as(admin_prov)

    # Ver acciones
    response = client.get('/admin/audit/actions')

    # SOLO ve acciones de su cl√≠nica
    assert 'create_ticket' in response.data
    assert 'modify_fpa' NOT in response.data
                </div>

                <h3>Opci√≥n 2: P√°gina de Validaci√≥n Manual</h3>
                <div class="code-block">
# routes/admin.py

@admin_bp.route('/audit/validate')
@login_required
def validate_audit_logs():
    """P√°gina de validaci√≥n de logs por perfil."""

    if not current_user.is_superuser:
        flash('Solo superusuarios pueden validar logs')
        return redirect(url_for('dashboard.index'))

    # Contar logs totales
    total_login_logs = LoginAudit.query.count()
    total_action_logs = ActionAudit.query.count()

    # Contar logs por cl√≠nica
    logs_by_clinic = db.session.query(
        LoginAudit.clinic_id,
        func.count(LoginAudit.id)
    ).group_by(LoginAudit.clinic_id).all()

    # Verificar que cada cl√≠nica tiene logs
    clinics = Clinic.query.all()
    validation_results = []

    for clinic in clinics:
        logs_count = LoginAudit.query.filter_by(clinic_id=clinic.id).count()
        validation_results.append({
            'clinic': clinic.name,
            'logs_count': logs_count,
            'status': 'OK' if logs_count > 0 else 'WARNING'
        })

    return render_template('admin/audit_validation.html',
                         results=validation_results,
                         total_logs=total_login_logs)
                </div>
            </div>

            <!-- CHECKLIST -->
            <div class="section">
                <h2>‚úÖ Checklist de Validaci√≥n</h2>

                <div class="alert alert-success">
                    <h3 style="margin-bottom: 10px;">Tests a Implementar</h3>
                    <ol>
                        <li>‚úÖ Superusuario ve todos los logs de todas las cl√≠nicas</li>
                        <li>‚úÖ Superusuario ve columna "clinic_id" en UI</li>
                        <li>‚úÖ Admin solo ve logs de su cl√≠nica (LoginAudit)</li>
                        <li>‚úÖ Admin solo ve acciones de su cl√≠nica (ActionAudit)</li>
                        <li>‚úÖ Admin NO ve logs de otras cl√≠nicas (isolation)</li>
                        <li>‚úÖ Clinical/Visualizador siguen misma l√≥gica que Admin</li>
                        <li>‚úÖ Filtros de b√∫squeda respetan multi-tenancy</li>
                        <li>‚úÖ Creaci√≥n de logs incluye clinic_id correcto</li>
                    </ol>
                </div>
            </div>

            <!-- BENEFICIOS -->
            <div class="section">
                <h2>üéØ Beneficios de Esta Validaci√≥n</h2>

                <ul style="padding-left: 25px; font-size: 1.05em;">
                    <li><strong>Seguridad:</strong> Garantiza que no hay fugas de informaci√≥n entre cl√≠nicas</li>
                    <li><strong>Compliance:</strong> Auditor√≠a correcta es requerimiento legal en salud</li>
                    <li><strong>Confianza:</strong> Tests autom√°ticos previenen bugs de seguridad</li>
                    <li><strong>Debugging:</strong> Facilita identificar problemas de permisos</li>
                    <li><strong>Mantenibilidad:</strong> Cambios futuros no romper√°n isolation</li>
                </ul>
            </div>
        </div>

        <footer style="background: #2d3748; color: white; padding: 20px; text-align: center;">
            <p><strong>Issue Propuesta:</strong> Validar logs de acceso por perfil con tests autom√°ticos</p>
            <p style="margin-top: 10px; opacity: 0.8;">Ticket Home - Sistema de Gesti√≥n de FPA RedSalud</p>
        </footer>
    </div>
</body>
</html>
